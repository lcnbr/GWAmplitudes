---
editor:
      render-on-save: true
---
# Scattering amplitudes and Gravitional waves


::: {.content-hidden unless-format="html"}


{{< include latexmacros.tex >}}
\newcommand{\sumint}{\int\mathllap{\sum}}

:::

Whilst we have almost no hope to detect any \acr{gw} scattering events with current experiments, scattering calculations can still be very useful in the quest for orbital waveforms. Most importantly, while experimental data is not driving gravitational scattering theory, particle scattering experiment and theory have been an enormously fruitful endeavor for High energy physics. The back and forth between precise measurements (such as those conducted at the \acr{lhc}) and precise predictions for particle scattering, has pushed the boundaries of the calculations possible. It would be therefore very beneficial if one could apply the large knowledge acquired for small non-gravitationally interacting particles, to large compact orbiting bodies. 

Such techniques as \acr{eft}, double copy, generalized unitarity, \acr{ibp} reduction, differential equations methods, ll standing on the shoulders of feynman perturbative techniques have been applied to the scattering problem in gravity. A key part of applying tools originally devloppedd for mostly quantum systems is controlling the classical limit, and is part of the solution to implementing gravity in a \acr{qft} framework, a historically difficult endeavor. Once scattering data is obtained one needs to extract the relevant observables. This may be in an effort to compare results from the different methods, in which case gauge and diffeomorphism invariance are key, or to extract the relevant information for detection and data extraction, in which case the \acr{gw} waveform is the relevant observable. In the latter case one is mostly interested in the orbital waveform, and thus a map from unbound to bound orbits is necessary. 

Multiple formalisms have arisen to map the scattering problem to an orbital one, and the quantum formalism to a classical one. One key way is to map scattering data to the potential (as present in a hamiltonian for example). In fact this has been developped as early as the 1970s in [@Hiida:1972xs;@Iwasaki:1971vb]. Further developpents happened in [@Neill:2013wsa;@Bjerrum-Bohr:2013bxa;@Vaidya:2014kza;@Cachazo:2017jef;@Guevara:2017csg;@Damour:2016gwp]. Here we will follow the treatement in @Cheung:2018wkq, where one uses the conservative part of such scattering amplitudes to match to an \acr{eft} and subsequently to map to the potential. Recently efforts to add disipative effects have been succesful aswell [see @Kalin:2022hph]. This potential can then be used as input to the \acr{eob} formalism. Furthermore, @Kalin:2019rwq; @Kalin:2019inp, have shown a path forward in directly extending unbound data to bound orbits, obviating the need to use a potential and \acr{eob} at all. 

Finally as mentioned in the last chapter, scattering can stand on its own and is still usefull, unextended to the orbital case. The \acr{pm} approximation can be computed from scattering amplitude in an \acr{eft} framework [@Kalin:2020mvi]. We can also explore the classical observables possible in scattering scenarios. This has been developped in @Kosower:2018adc and was extended to local observables^[local as in not time integrated and thus presenting time dependent dynamics] such as waveforms  in @Cristofoli:2021vyo.


In this chapter we will first look at how one uses amplitude data to extract orbital and scattering waveforms. We will then look at the \acr{kmoc} formalism to directly extract observables. Finally we will look at obtaining these amplitudes, combining all the methods and comparing to results such as those in [@Kosower:2018adc; @Bern:2021xze].

## Scattering amplitudes {#sec-scatamp}     

In \acr{qft} one way to encode scattering data is through a scattering amplitude. Consider a process where one starts out with a set of particles described by a state $\ket{i}$, we let them interact, and end up with a final state $\ket{f}$. The scattering amplitude is then defined as the probability amplitude for this process to occur. It simply given by 
$$\mel{i}{\Smat-1}{f}=(2\pi)^4 \deltafn[(4)]{p_f-p_i}\im \ampl_{fi},$$

where $\Smat$ is essentially the operator that 'does the scattering'. We subtract the identity from it, forming what some call the transfer matrix $\Tmat$ as we only are interested in processes where something happens (i.e. not everything stays the same). In the above equation we also define the *scattering matrix element* $\ampl_{fi}$ [see @Srednicki:2007, p. 76] or *invariant Feynman amplitude* [see @Coleman:2018, p.214], by factoring out a normalised spacetime delta-function imposing conservation of momentum on the external fields, and a complex unit. The key point is that this amplitude can be computed using graphical techniques. This makes use of the \acr{lsz} [@Lehmann:1954rq;@Collins:2019ozc] formalism where such an amplitude  $\ampl_{fi}$, can be computed from products of time ordered correlation functions of the given QFT. These are also called Green's functions, who can then be encoded by sums of Feynman diagrams. The diagrams are generated by applying feynman rules which can be readily obtained from an action describing the theory. This technique will be exemplified in the following sections.

## From amplitude to potential

Let us now look at how to map the amplitude to the gravitational potential, for use in the \acr{eob} formalism. We will follow the treatment in @Cheung:2018wkq. We first start with defining the effective theory that describes our problem as two scalar fields $\wf[1]$ and $\wf[2]$ with masses $\mass[1]$ and $\mass[2]$ interacting through a long range potential $V(r)$. It is the \acr{eft} for  non-relativistic fields. This \acr{eft} is described by the following action:

$$
\action=\int \dd{t} \lag[kin]+\lag[int]
$$

where the kinetic term is given by:

$$
\begin{aligned}
\lag[kin]=&\int \dn[\small \Dim-1]{\tv{k}} \cwf[1](-\tv{k}) \pa[\Big]{\im \partialder[t]-\sqrt{\tv{k}^2+\mass[1]} }\wf[1](\tv{k})
\\
&+\int \dn[\small \Dim-1]{\tv{k}} \cwf[2](-\tv{k}) \pa[\Big]{\im \partialder[t]-\sqrt{\tv{k}^2+\mass[2]} }\wf[2](\tv{k})
\end{aligned}
$$

and the interaction term is given by:

$$
\lag[int]=  -\int \dn[\small \Dim-1]{\tv{k}} \dn[\small \Dim-1]{\tv{k'}} \pot(\tv{k},\tv{k'}) \cwf[1](\tv{k'}) \cwf[2](-\tv{k'}) \wf[1](\tv{k}) \wf[2](- \tv{k})
$$

This theory is obtained from the full one by integrating out all the massless force carriers , which are consequently encoded in the potential $\pot(\tv{k},\tv{k'})$ and taking the non-relativistic limit $\abs{\tv{k}},\abs{\tv{k'}}\ll \mass[1,2]$. In a classical system we consider the particles to be separated by a distance $\abs{\tv{r}}\sim\inv{\abs{\tv{k}-\tv{k'}}}$ much larger than their compton wavelengths $\comptlen\sim\inv{\abs{\tv{k}}},\inv{\abs{\tv{k'}}}$. This results in the following heirarchy of scales:

$$
\abs{\tv{k}-\tv{k'}}\ll\abs{\tv{k}},\abs{\tv{k'}}
$$

This can be expressed in terms of angular momentum $\tv{J}\sim\abs{\tv{k}\times\tv{r}}$, thus $\abs{\tv{k}},\abs{\tv{k'}}\propto 1 +\inv{J}$:

$$
  \inv{J} \propto \abs{\tv{k}-\tv{k'}}\propto \inv{\kappa}
$$

where $\kappa$ is the coupling constant, which in the case of gravity is $\kappa=4\pi\grav$. This last relation is due to the virial theorem. nnsince the potential must encode the coulomb potential $\kappa/\abs{\tv{k}-\tv{k'}}^2\propto J^3$, it must scale similarly. We thus formulate the following ansatz for the potential:

$$
\pot(\tv{k},\tv{k'})=\sum_{n=0}^\infty \frac{\kappa^n}{\abs{\tv{k}-\tv{k'}}^{\Dim-1-n}} c_n\pa[\Big]{\frac{\tv{k}^2+\tv{k'}^2}{2}}
$${#eq-ansatzpot}

Note that higher order terms in the potential could be formed by any combination of momentum invariants $\tv{k}^2$, $\tv{k'}^2$, and $\tv{k}\cdot\tv{k'}$, however all combinations of these are not all independent. The ansatz is chosen such that only the combination $\abs{\tv{k}-\tv{k'}}$ and $\tv{k}^2+\tv{k'}^2$, the others being combinations reachable by field redefinition, or vanishing on-shell, such as $\tv{k}^2-\tv{k'}^2$. Note aswell that we work in $\Dim=4-2\dimreg$ dimensions such that the integrals are dimensionally regulated [see @tHooft:1972tcz], and in this case an $\dimreg$-power corresponds to a logarithm^[the third term in the sum is given by $\coupling^3\ln{\tv{k}-\tv{k'}}^2 c_3\pa[\Big]{\Half{\tv{k}^2+\tv{k'}^2}}$].Finally note that in gravity this is precisely a \acr{pm} expansion! 


### EFT amplitude

The first step in establishing a link to the potential from a generic scattering amplitude computed in the full theory is to compute the amplitude in the \acr{eft}. We first identitify the Feynman rules from the action. The kinetic term encodes the propagator: 

```{julia}
#| echo: false
#| eval: false
#| output: false
#| fig-align: center
using TikzPictures

tp = TikzPicture(L"""
\matrix 
{    \draw[line width=.3mm,->-=.5,bicolor={red}{blue}] (-1.5,0)  --  (1.5,0) node[midway,above,color=black]{$\displaystyle(k_0,\mathbf{k})$}; &
    \node{$=$}; &
    \node {$\displaystyle\frac{\im}{k_0-\sqrt{\mathbf{k}^2+m_{\textcolor{red}{1}, \textcolor{blue}{2}}^2}+\im 0}$}; \\
  };"""
, options="thick, transform shape",preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings}\\input{../latexmacros.tex}\\usepackage{xcolor}")
save(PDF("./tikz/propagator.pdf"), tp)
save(TEX("./tikz/propagator"; limit_to=:picture), tp)
tp
```
![Propagator rule](tikz/propagator){#fig-propagator}


Where the $\im 0$ is the Feynman prescription for avoiding the poles. The interaction term encodes the vertex:


```{julia}
#| echo: false
#| eval: false
#| output: false 
#| fig-align: center 
using TikzPictures

tp = TikzPicture(L"""


\matrix 
{    \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,anchor node=a] 
{
  {i1} --[->-=.5,thick,"$\displaystyle \mathbf{k}$" font=\large,red]  a[circle,fill,scale=.6] --[->-=.6,thick,"$\displaystyle \mathbf{k'}$" {font=\large},red] o1;
  i2 --[->-=.5,thick,"$\displaystyle -\mathbf{k}$" {font=\large, below,yshift=-5},blue]  a --[->-=.6,thick,"$\displaystyle  - \mathbf{k'}$"  {font=\large, below,yshift=-5,xshift=-5},blue] o2;
};
&
    \node{$=$}; &
    \node {$\displaystyle\iunit V(\mathbf{k},\mathbf{k'})$}; \\
  };"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")
save(PDF("./tikz/vertex.pdf"), tp)
save(TEX("./tikz/vertex"; limit_to=:picture), tp)
tp
```

![Vertex rule](tikz/vertex){#fig-vertex} 

The key point is that the EFT amplitude for two-to-two scattering must be equal, to the full amplitude at every order in the coupling constant $\coupling$. The expression for the \acr{eft} amplitude will contain the coefficent functions from @eq-ansatzpot since they will be present as vertex terms. Particle number must be conserved in the non-relativistic limit ^[as pair production is kinematically forbidden], so the amplitude is a sum of bubble diagrams:

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
\matrix{
      \node{$\ampl_\text{EFT}$};&
      \node{$=$};&
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6]  --[->-=.6,thick,blue] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=a to d,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6] --[->-=.6,thick,red] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red,bend right=90] d --[->-=.6,thick,blue] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=a to d,horizontal=i1 to o1,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6]--[->-=.6,thick,blue,bend left=90] c[circle,fill,scale=.6] --[->-=.6,thick,blue] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red,bend right=90] d--[->-=.6,thick,red,bend right=90] c --[->-=.6,thick,red] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,horizontal=a to b,anchor node=a]{
            {i1} --[->-=.5,thick,red]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] b[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] c[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6] --[->-=.6,thick,red] o1;
            i2 --[->-=.5,thick,blue]  a --[->-=.6,thick,red,bend right=90] b --[->-=.6,thick,red,bend right=90] c --[->-=.6,thick,red,bend right=90] d --[->-=.6,thick,blue] o2;};&
      \node{$+$};&
      \node{$\cdots$};
      \\
};"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(PDF("./tikz/eftampl.pdf"), tp)
save(TEX("./tikz/eftampl"; limit_to=:picture), tp)
tp
```

![EFT amplitude](./tikz/eftampl){#fig-eftampl}

see @fig-eftampl
We can consequently neatly organise the amplitude into a sum of terms with specific loop counts. We can also equivalently organise it into a sum of terms with specific $\coupling$ powers. We write,

$$\ampl_\text{EFT}=\sum\limits_{i=1}^\infty \ampl_\text{EFT}^{(i)}=\sum\limits_{L=0}^\infty\ampl_\text{EFT}^{L\text{loop}}$$

 Notably, these partitions do not line up for the \acr{eft} since the vertex contains all powers of the coupling. This is in contrast to the full theory where usually they yield the same partition. We will eventually want to partition over the coupling power  to compare the the full theory.



Since every vertex has degree 4, and we have two scalars in and two scalars out, it is convient to define a 2-body propagator, where we already integrate over the energy component of the loop momentum, since the vertex does not have an energy dependence:^[the 4-momentum conservation at each vertex means that the energy components of the two propagating momenta must carry along the energy component of the initial state $\energy=\energy[1]+\energy[2]$. This can be encoded by demanding that $\omega_1+\omega_2=\energy$.  Taking the \acr{com} frame for the intial momenta means that the 3 momenta of each propagator must cancel i.e. $\tv[1]{k}+\tv[2]{k}$]


$$\im \proptwobody{\tv{k}}=\int \dn{\omega} \frac{\im}{\omega-\sqrt{\tv{k}^2+m_1^2}}\frac{\im}{\energy-\omega-\sqrt{\tv{k}^2+m_2^2}}=\frac{\im}{\energy-\sqrt{\tv{k}^2+\mass[1]^2}-\sqrt{\tv{k}^2+\mass[2]^2}}$$

where the integral is performed using the residue theorem, closing the contour in either half plane, where in either case a pole is present. Note that we define $\energy=\energy[1]+\energy[2]$ to be the \acr{com} energy of the inital two states:^[which is equal to the outgoing energy]

$$
\energy[1,2]=\sqrt{\tv{p}^2+\mass[1,2]^2}=\sqrt{\tv{p'}^2+\mass[1,2]^2},
$$

where $\tv{p}$ and $\tv{p'}$ are the initial and final three-momenta of the two states ^[for example in the initial state one scalar field will have 3-momentum $\tv{p}$, and the other $-\tv{p}$] in the \acr{com} frame. Finally we can write what the diagram at loop level $L>0$ encodes:

$$ 
\ampl_\text{EFT}^{L\text{loop}}= \int\prod\limits_{i=1}^L  \dn[\small \Dim-1]{\tv[i]{k}} \pot(\tv{p},\tv[1]{k})\proptwobody{\tv[1]{k}}\cdots\proptwobody{\tv[L]{k}}\pot(\tv[L]{k},\tv{p'})
$$

This integral can be perfomed in the non-relativistic limit, as done by @Bern:2019crd up to 3\acr{pm}, using \acr{ibp} reduction yielding, up to two PM, the amplitudes of the \acr{eft}:^[here the repartioning mentioned above has been applied and a change in loop momenta: $\tv[i]{k}\to\tv{p}+\tv[i]{\ell}$] 

$$
\begin{aligned}
\ampl_\text{EFT}^{(1)}&=-\frac{4\pi\grav c_1}{\tv{q}^2}\\
\ampl_\text{EFT}^{(2)}&= \pi^2\grav^2 \Big(-\frac{2 c_2}{\abs{\tv{q}}}+\inv{\energy \redEratio \abs{\tv{q}}}\brc[\Big]{(1-3\redEratio)c_1^2+4\redEratio^2\energy^2c_1 c'_1}\\
                  & \int \dn[\Dim-1]{\tv{\ell}}\frac{32\energy\redEratio c_1^2}{\tv{\ell}^2(\tv{q}+\tv{\ell})^2(\tv{\ell}^2+2\tv{p}\tv{\ell})}\Big)
\end{aligned}
$$

where $\redEratio=\frac{\energy[1]\energy[2]}{\pa{\energy[1]+\energy[2]}^2}$ is the reduced energy ratio, the arguments of the coefficent functions $c_1$ are kept iplicit and a prime denotes a derivative with respect to $\tv{\emom}$. Additionally we define $\tv{q}=\tv{p'}-\tv{p}$ to be the 3-momentum transfer. Now provided we obtain the amplitude of the full theory we have that

$$
\ampl_\text{EFT}^{(i)}=\ampl_\text{full}^{(i)} \quad \forall i
$$

This enables us to fix the coefficients in the potential ansatz @eq-ansatzpot.  This fullfils the promised map from amplitude to potential. 


## B2B map



## \acr{kmoc}

The setup of the \acr{kmoc} framework (@Kosower:2018adc) is very general, and is aimed at taking the classical limit of a scattering event in an unspecified theory. We will later on apply it to \acr{sqed} and gravity. First let us define our conventions. Throughout we use relativistically natural units, i.e. we do *not* set $\hbar=1$. In dimensional analysis we can therefore see that $c=1$ means that $[L][T]^{-1}=1 \implies [L]=[T]$, 
$$q
\energy=mc^2\implies[\energy]=[m]=[M]
$$ 

and 

$$
\energy=\hbar \omega\implies [M]=[\hbar][T]^{-1}\implies [\hbar]=[T][M]
.$$ 

Thus momentum $\emom$ is in units of $[\emom]=[M]$ mass and Wavenumber $[\bar{\emom}]=[\frac{\emom}{\hbar}]=[T]^{-1}$ is in units of inverse time. 
We will denote the on $m$ shell measure by $\ddP{p}$^[Repeated integration will be denoted $\ddP[n]{p_1,\dots,p_n}$]:

$$
\int \ddP{p} \dots      = \int \frac{\dd[3]{\tv{p}}}{2\shellen (2\pi)^3} \dots = \int \dn[4]{p}\nposendelta[-m^2]{p} \dots
$$

where quantities denoted by bars have absorbed the relevant factors of $2\pi$, such that $\dn[n]{p}=\frac{\dd[n]p}{(2\pi)^n}$. Additionally we have defined $\shellen=\sqrt{\tv{p}^2+m^2}$ to be the on shell energy and  $\delta^{(+)}$ is the normalised positive energy on-shell delta function:

$$
\nposendelta[-m^2]{p}=(2\pi)\deltafn{\lv{p}^2-m^2}\thetafn{\ct[0]{p}}=\ndeltafn{\lv{p}^2-m^2}\thetafn{\ct[0]{p}}
$$





With our conventions at hand, let us set the stage for the problem. Imagine we want to scatter two particles, be they massive black holes, or tiny electrons into each other, with a constant particle number (i.e. a classical two in two out scattering). As said in @sec-scatamp, in \acr{qft} the framework that formalizes scattering of definite particle number states is called the \acr{lsz} reduction. 

[we work in the Heisenberg picture here]{.aside}

Let us look at it in more detail. The first component is to define the states we want to scatter. Suppose our theory has one particle states $\momket$, with mass $\mass$, eigenstates of the momentum:

$$\ct{\momop}\momket=\ct{\emom}\momket \quad \text{where} \quad p^0=\shellen=\sqrt{\tv{\emom}^2+\mass^2}$$

These states can be seen as special cases (the plane wave states) of wavepacket states:^[A plane wave state $\ket{f}=\momket$ would be given by $\shellft{f}(k)=2 \shellen[\tv{k}]  \ndeltafn[(3)]{\tv{k}-\tv{p}}$]

$$\ket{f}=\int \ddP{k} \shellft{f}(k) \momket[k]$$

where $\shellft{f}(k)$ is the momentum space wavefunction or more mathematically the momeentum distribution function. Note that it is almost a fourier transform, but not quite, as it is performed on mass shell. If the we have the spactime 'wavefunction' ^[Note that the concept of coordinate space wavefunction is ill defined in interacting theories. However for such asymptotic states, the wavefunction outside the bulk (on the infinte time boundary) is that of a free wavefunction] given by:

$$f(x)=\int \ddP{k} \shellft{f}(k) \exp{-\im\lv{k}\cdot\lv{x}}$${#eq-spacetimewf}

The $\shellft{f}(k)$ is then given by:

$$\ip{k}{f}=\shellft{f}(k)= 2 \shellen \int \dd[3]{\tv{x}}f(x) \exp{\im k\cdot x}$${#eq-momdist}


If we now define the following operators:^[$f\lrder g=f\pa{\partialder[\mu]g}-\pa{\partialder[\mu]f}g$]

:::{.aside}
Note that if we replace $f(x)$ by a plane wave state  $\exp{-\im k\cdot x}$ we obtain and define the following:

$$
\createop[\tv{k}](t)=  \int \dd[3]{\tv{x}} \exp{-\im k\cdot x} \brc[\Big]{\shellen[\tv{k}]\wf(x)-\im \partialder[0]\wf(x)}
$$

$$
\annihilop[\tv{k}](t)=   \int \dd[3]{\tv{x}} \exp{\im k\cdot x} \brc[\Big]{\shellen[\tv{k}]\wf(x)+\im \partialder[0]\wf(x)}
$$

:::

$$
\createop[f](t)= -  \im \int \dd[3]{\tv{x}}f(x) \lrder[0] \wf(x)
$$

$$
\annihilop[f](t)=   \im \int \dd[3]{\tv{x}}\conj{f}(x) \lrder[0] \wf(x)
$$

where $\wf(x)$ is the Heisenberg field operator. Note that while these operators are time dependent, this dependence is not given by applying the Heisenberg \acr{eom}s ^[$\odv{A_H(t)}{t}=\im\com{H_H}{A_H(t)}$], instead it is present through the time dependence of the wavefunction $f(x)$. It turns out that these operators, suggestively written are the true creation and annilihation operators in the interacting theory. 

Now we can actually define a general one particle state $\ket{f}$ as the result of a creation operator acting on the physical vacuum. Crucially however this only makes sense in the boundary of the bulk, i.e. at asymptotic times $t\to\pm\infty$.^[see @Coleman:2018 or @Collins:2019ozc for a more in depth discussion of this point]. Inside the bulk, any thusly created state would infact not have definite particle number. This definitely makes sense in the scattering problem because if you consider the whole system as a state, is only has definite particle number at asymptotic times, and inside the bulk the scattering happens, and the particle number is not conserved (at least quantum mechanically). 

Consequently we only define asymptotic states, denoting them by an $\text{in}$ subscript if they were created at $t\to-\infty$ and $\text{out}$ if they were created at $t\to+\infty$. Thus we define a generic one particle in state as:

$$ 
\ket[in]{f}\defeq\lim_{t\to-\infty}\createop[f](t)\physvack=\createop[f;\text{in}]\physvack=\int \ddP{k} \shellft{f}(k) \underbracket{\createop[\tv{k}]\physvack}_{\momket[k]}
$$

and the corresponding $t \to +\infty$ state where in is replaced with out. It turns out the extension to multiparticle states is not much more complicated. The one thing to demand is that the momentum distributions say $\shellft{f_1},\shellft{f_2},\dots$ have no common support, i.e. they are not overlapping. In this case a n-particle in state is defined as: 

$$
\ket[in]{f_1,\dots,f_n}\defeq\createop[f_1;\text{in}]\createop[f_2;\text{in}]\dots\createop[f_n;\text{in}]\physvack=\int \ddP[n]{k_1,\dots,k_n} \shellft{f_1}(k_1)\dots\shellft{f_n}(k_n) \momket[k_1,\dots,k_n] 
$$

We now have the definitions for asymptotic in and out states for any number of particles. Before continuing to define the setup to scatter our two particles, let us look at the meaning of the position space wavefunction $f(x)$ as defined in @eq-spacetimewf. If we consider a sharply peaked, compactly supported momentum distribution $\shellft{f}(k)$ around a value $\tv[0]{p}$ and a characteristic width $\Delta p$. One such function could be:

$$
f\pa{\tv{p} ; \tv[0]{p}, \Delta p}=\left\{\begin{array}{ll}
N \exp{-1 /\pa{1-\abs{\tv{p}-\tv[0]{p}}^2 / \Delta p^2}} & \text { if }\abs{\tv[0]{p}-\tv{p}}<\Delta p \\
0 & \text { if }\abs{\tv[0]{p}-\tv{p}} \geq \Delta p
\end{array}\right.
$$

where $N$ is a normalization constant. Now the integrand in @eq-spacetimewf, at large $t$ or $\tv{x}$, will be dominated by the stationary phase point $\tv[s]{p}$ which is given by:^[This then means that $$\tv[s]{p}=\frac{\mass\tv{x}\sign{t}}{\sqrt{t^2-\tv{x}^2}}$$ thus $$\shellen[{\tv[s]{p}}]=\frac{\mass\abs{t}}{\sqrt{t^2-\tv{x}^2}}$$]
$$0=-\pdv{}{\tv[s]{p}}\shellen[{\tv[s]{p}}]t+\tv[s]{p}\cdot\tv{x}=-\frac{\tv[s]{p}t}{\shellen[{\tv[s]{p}}]}+\tv{x}$${#eq-stationaryphase}

In the case of a sharply peaked momentum distribution, the coordinate space wavefunction will be largest when the stationary phase point is be the same as the peak of the momentum distribution, i.e. $\tv[s]{p}=\tv[0]{p}$ i.e. substituting $\tv[s]{p}$ into  @eq-stationaryphase gives:
$$
\tv{x}\simeq \frac{\tv[0]{p}t}{\shellen[{\tv[0]{p}}]}=\tv[0]{v}t
$$

This is precisely the trajectory of the classical relativistic particle. If we have two particles with different peaked momentum distributions their trajectories will have different velocities, but the same positions at time $0$. Thus we will shift one of these trajectories by a so called impact parameter $\ct{\impactParameter}$[^shift], parametrising the relative separtation of the two particles/wavepackets. This can be simply done by multiplying the momentum distribution $\shellft{\wf[1]}(p)$ by a factor of $\exp{\frac{\im}{\hbar} \impactParameter \cdot p}$. We take it to be perpendicular to the initial momenta $\emom[1],\emom[2]$. We now can write down the initial state that we are going to study:

$$
\ket{\text{in}}=\int \ddP[2]{\emom[1],\emom[2]} \shellft{\wf[1]}(\emom[1]) \shellft{\wf[2]}(\emom[2]) \exp{\frac{\im}{\hbar} \co{\impactParameter} \ct{\emom[1]}}\ket[in]{\emom[1],\emom[2]}
$${#eq-instate}


From now on we will drop the breve and infer from the arguments the type of $\wf$ we are dealing with. The \acr{kmoc} framework concerns itself with the change of an observable during a scattering event. For such an observable $\obs{O}$, its change can be simply obtained by evaluating the difference of the expectation value of the corresponding Hermitian operator, $\mathbb{O}$, between in and out states
$$
\Delta O=\ev{\op{O}}{\text{out}}-\ev{\op{O}}{\text{in}}
$$

In quantum mechanics, the out states are related to the in states by the time evolution operator, i.e. the S-matrix: $\ket{\text{out}}=\Smat \ket{\text{in}}$ and we can write

::: {.aside}
In order, we use the unitarity of the S-matrix, then express the S-matrex as the identity (no actual interaction) and the transfer matrix $\Tmat$. The commutators are then expanded and the part with the identity vanish (as $\id$ commutes with everything). 
:::

$$
\begin{aligned}
\Delta O    &=\ev{\adj{\Smat}\op{O}\Smat}{\text{in}}-\ev{\op{O}}{\text{in}}\\
            &\stackrel{\adj{\Smat} \Smat=\id}{=}      \ev{\adj{\Smat} \com{\op{O}}{\Smat}}{\text{in}}\\
            &\stackrel{\Smat=\id+\im \Tmat}{=}          \ev{\com{\op{O}}{\id+\im \Tmat}}{\text{in}}
                                                      -\ev{\im \adj{\Tmat} \com{\op{O}}{\id+\im \Tmat}}{\text{in}}\\
            &=    \ev{\im\com{\op{O}}{\Tmat}}{\text{in}}
                  +\ev{ \adj{\Tmat} \com{\op{O}}{\Tmat}}{\text{in}}\\
            &=\vchangeob+\Delta O_\text{r}
\end{aligned}
$${#eq-DeltaO}


If we put in the definition of our in state (@eq-instate) we have:


$$
\Delta O = \int \ddP[4]{\emom[1],\emom[2],\emom[1]',\emom[2]'} 
                  \wf[1](\emom[1]) \wf[2](\emom[2]) \cwf[1](\emom[1]') \cwf[2](\emom[2]')
                  \,\exp{\im \co{\impactParameter} \frac{\ct{\emom[1]}-\ct{\emom[1]'}}{\hbar}}
                  \brc[\big]{\vInt-\rInt}
$$
Where we define the real integrand $\rInt$ and the virtual integrand $\vInt$ as the following matrix elements:
$$
\begin{aligned}
\vInt &=\bra[in]{\emom[1]'\emom[2]'}{\im\com{\op{O}}{\Tmat}           }\ket[in]{\emom[1]\emom[2]}\\
\rInt &=\bra[in]{\emom[1]'\emom[2]'}{\adj{\Tmat}\com{\op{O}}{\Tmat}   }\ket[in]{\emom[1]\emom[2]}
\end{aligned}
$$

[NB: the notation is slightly different in the @Bern:2021xze paper]{.aside}

Let us first look at the virtual integrand $\vInt$:^[Here we define $$\obs{O}_{\text{in}}\ket{\emom[1]\emom[2]}=\op{O}\ket{\emom[1]\emom[2]}$$ aswell as, $$\obs{O}_{\text{in}}'\bra{\emom[1]'\emom[2]'}=\bra{\emom[1]'\emom[2]'}\op{O}$$ and finally $$\obschange{\emom'-\emom}=\obs{O}_{\text{in}}'-\obs{O}_{\text{in}}$$]

$$
\begin{aligned}
\vInt &=\bra[in]{\emom[1]'\emom[2]'}{\im\com{\op{O}}{\Tmat}     }\ket[in]{\emom[1]\emom[2]}  \\
      &=\bra[in]{\emom[1]'\emom[2]'}{\im\op{O}\Tmat             }\ket[in]{\emom[1]\emom[2]}   
      - \bra[in]{\emom[1]'\emom[2]'}{\im \Tmat\op{O}            }\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obs{O}_{\text{in}'}  \; \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}
      - \im \obs{O}_{\text{in}} \;    \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obschange{\emom'-\emom} \,    \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obschange{\emom'-\emom}\,\ndeltafn[4]{\emom[1]+\emom[2]-\emom[1]'-\emom[2]'} 
                                    \amp{\emom[1],\emom[2]}{\emom[1]',\emom[2]'}
\end{aligned}
$$

Note that the amplitude is from in states to in states! Now for the real integrand $\rInt$ we insert a complete set of states :[^complete]

$$
\begin{aligned}
\rInt &=\bra[in]{\emom[1]'\emom[2]'}{\adj{\Tmat}\com{\op{O}}{\Tmat}}\ket[in]{\emom[1]\emom[2]}\\
      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}   \bra[in]{\emom[1]'\emom[2]'}\adj{\Tmat}\vert{r_1 r_2 X}\rangle\langle {r_1 r_2 X} \vert
                        \com{\op{O}}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}  \ndeltafn[4]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}}\,
      \amp{\emom[1], \emom[2]}{r_{1}, r_{2}, r_{X}} \\
      &\qquad \obschange{rX-\emom}\,\ndeltafn[4]{\emom[1]'+\emom[2]'-r_{1}-r_{2}-r_{X}}\,
      \aamp{\emom[1]', \emom[2]'}{r_{1}, r_{2}, r_{X}}
\end{aligned}
$$

For both integrands we can preform some variable changes and eliminate certain delta functions. We introduce momentum shifts $q_i=\emom[i]'-\emom[i]$ and then integrate over $q_2$ finally relabelling $q_1 \to \tm$   [^measureshift]. Thus we have

$$
\begin{aligned}
\vchangeob=\int \ddP[2]{\emom[1],\emom[2]} \dn[4]{\tm}
      &\ndeltafn{2 \emom[1] \cdot \tm+\tm^2} \thetafn{\ct[0]{\emom[1]}+\tm^0}\, \ndeltafn{2 \emom[2] \cdot \tm-\tm^2} \thetafn{\ct[0]{\emom[2]}-\tm^0}\\
      &\times\wf[1](\emom[1])\wf[2](\emom[2])\cwf[1](\emom[1]+\tm)\cwf[2](\emom[2]-\tm)\,\exp{-\frac{\im}{\hbar} \co{\impactParameter} \tm^\mu}\\
      &\times \im \obschange{\tm} \amp{\emom[1],\emom[2] }{\emom[1]+\tm,\emom[2]-\tm}
\end{aligned}
$${#eq-DeltaOv}


$$
\begin{aligned}
\rchangeob=\sum\limits_X \int \ddP[2+\abs{X}]{r_1, r_2,X}
      &\ddP[2]{\emom[1],\emom[2]} \dn[4]{\tm} \ndeltafn{2 \emom[1] \cdot \tm+\tm^2} \thetafn{\ct[0]{\emom[1]}+\tm^0}\\
            &\times \ndeltafn{2 \emom[2] \cdot \tm-\tm^2} \thetafn{\ct[0]{\emom[2]}-\tm^0}\\
            &\times\wf[1](\emom[1])\wf[2](\emom[2])\cwf[1](\emom[1]+\tm)\cwf[2](\emom[2]-\tm)\,\exp{-\frac{\iunit}{\hbar} b_\mu \tm^\mu}\\
            &\times\obschange{rX-\emom}\ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
            &\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}}\aamp{\emom[1]+\tm, \emom[2]-\tm }{r_{1}, r_{2}, r_{X}}
\end{aligned}
$${#eq-DeltaOr}

We have arrived at an integral expression for the change in observable $\obs{O}$ during observable. Luckily for us, we will not need to perform these integrals in the classical limit. We will just have carefully chosen replacement rules for the integrated variables! Let us look at this in more detail now.



### Classical limit

Since we are concerned with classial observables we need to explore the classical limit of @eq-DeltaO, i.e. the limit of $\hbar \to 0$. The first target is the wavefunctions. 

#### Classical limit of wavefunctions

In \acr{kmoc} framework we are interested in the classical limit of a scattering event. It is then important to understand the precise simplifications this limit yields. 


We have multiple conditions on the wavefunctions. The first are those imposed by \acr{lsz} reduction. That is,

- Compact support momentum space wavefunction
- Peaked around one value of momenta

Classical limit of the wavefunctions should make sense, thus 

- as $\hbar \to 0$ the wavefunction should approach a delta function
- The spread should not be too large as to interact between the two initial states
- The overlap between the wavefunction and its conjugate should be nearly full, since they represent the same particle classically.

Consider for example a nonrelativistic wavefunction:

$$
f(\tv{\emom})=\Exp[\Big]{-\frac{\tv{\emom}}{2 \hbar m \comptlen/\ell_\omega^2}}\stackrel{\hbar=\comptlen m}{=}\Exp[\Big]{-\frac{\tv{\emom}}{2 m^2 \comptlen^2 /\ell_\omega^2}}
$$

This wavefunction grows sharper in the $\hbar \to 0$ limit. 

The Fourier transform of $f(\tv{\emom})$ gives us the position "probability density":[^constA]
$$
\begin{aligned}
\invFT[\tv{\emom}]{f}{\tv{x}}(\tv{x})   &=\int \frac{\dd{\tv{\emom}}}{2 \pi} \Exp[\Big]{-\pa[\big]{\frac{\tv{\emom}}{A}}^2}\Exp[\Big]{-\frac{\iunit}{\hbar} \tv{\emom}\cdot \tv{x}}\\
            &=\frac{1}{2\pi}\underbracket{\int \dd{\tv{\emom}} \Exp[\Big]{-\pa[\Big]{\frac{\tv{\emom}}{A}-\frac{\iunit\tv{x}A}{2 \hbar}}^2}}_{\sqrt{\pi}A}\Exp[\Big]{- \frac{\tv{x}^2A}{4 \hbar^2}}\\
      &=\frac{\sqrt{2}A}{2 \pi}\Exp[\Big]{-\frac{\tv{x}^2}{2 \ell_\omega^2}}
\end{aligned}
$$

This wavefunction grows sharper in the $\ell_\omega^2 \to 0$ limit. We must then still have that $\xi=\pa{\frac{\comptlen}{\ell_\omega}}^2\to0$ when $\hbar \to 0$ as-well. This works if we just directly take the classical limit to be the $\xi \to 0$ limit.


Going back to the general conditions we want $\wf[i](\emom[i])$ s.t:

- $\av{\ct{\emom[i]}}=\int \ddP{\emom[i]} \ct{\emom[i]} \abs{\wf[i](\emom[i])}^2\stackrel{!}{=}m_i \breve{u}_i^\mu f_{\emom,i}(\xi)$ [^2] with $f_{\emom,i}(\xi)=1+\mathcal{O}(\xi^{\beta'})$
- $\sigma^2(\emom[i])/m_i^2=\av{(\emom[i]-\av{\emom[i]})^2}/m_i^2=(\av{\emom[i]^2}-\av{\emom[i]}^2)/m_i^2=c_\Delta\xi^\beta$[^3]
- $\breve{u}_i \cdot u_i = 1+ \mathcal{O}(\xi^{\beta''})$

Additionally the wavefunction should be Lorentz invariant, thus naively we would have that $\wf(\emom[i]^\mu)=\tilde{\wf}(\emom[i]^2)$ however the integration measure enforces an on shell condition: $m_i^2=\emom[i]^2$. Thus the wavefunction cannot usefully depend on $\emom[i]^2$, we need to introduce at least one additional four vector parameter $u$. The simplest dimensionless combination of parameters it then $\frac{\emom \cdot u }{m}$. Of course the wavefunction must also depend on $\xi$ and the simplest form of argument will thus be $\frac{\emom \cdot u }{m \xi}$ so that any $\emom$ not aligned with $u$ will be strongly suppressed in the $\xi \to0$ limit.

We now have control over most of the conditions:

- The classical limit is well defined
- The wavefunction spread is controlled
- The arguments of the wavefunction is clear

The last requirement concerns the overlap of $\wf$ and $\cwf$ must be $\mathcal{O}(1)$, equivalently and more precisely:

$$
\cwf(\emom+\tm)\sim \cwf(\emom) \implies \cwf(\emom+\tm)- \cwf(\emom)\ll 1 \implies \ct{\tm}\partial_\mu{\cwf}(\emom)\ll1
$$
Making explicit the $\frac{\emom \cdot u }{m \xi}$ dependence: $\wf(\emom)=\varphi(\frac{\emom \cdot u }{m \xi})$   for $\varphi(x)$ a scalar function.
$$\implies \frac{\ct{\tm} u_\mu}{m \xi}\pdv{\varphi^\dagger}{x}(\frac{\emom \cdot u }{m \xi})\ll1$$
Thus we require that for a characteristic value of $\tm=\co[0]{\tm}$ we have:[^4]

$$
\frac{\co[0]{\tm}\cdot u}{m \xi}=\co[0]{\tw} \cdot u\frac{\ell_\omega^2}{\comptlen}\ll1\iff \co[0]{\tw} \cdot u\,\ell_\omega\ll \sqrt{ \xi}
$$

We now want to examine the classical limit of something like  @eq-DeltaOv. If we consider just the integration over the initial momenta $\emom[i]$ and the initial wavefunctions with $\ndeltafn{2 \emom[i] \cdot \tm+\tm^2}$, the delta function will smear out to a sharply peaked function whose scale is the same order as the original wavefunctions. As $\xi$ gets smaller, this function will turn back into a delta function imposed on the $\tm$ integration.[^5] Let us examine this statement more closely:


$$
d(m,\xi,u,\tm)=\int \ddP{\emom} \ndeltafn{2 \emom \cdot \tm+\tm^2} \thetafn{\emom^0+\tm^2}\varphi(\frac{\emom \cdot u }{m \xi})\varphi^\dagger(\frac{(\emom+\tm) \cdot u }{m \xi})
$${#eq-dfunct}


This integral must be Lorentz invariant and depends on $m,\xi, u,\tm$ thus it must manifestly only depend on the following Lorentz invariants: $u^2,\tm^2,u \cdot \tm, \xi$. One of these is not actually a variable as we will normalise $u^2=1$. The rest aren't fully dimensionless, and we can render them dimensionless:[^6]

$$\begin{aligned}
[\tm^2]&=[\hbar \tw]^2=[M]^2\implies[\comptlen \sqrt{-\tw^2}]=[\frac{\hbar}{m}\sqrt{-\tw^2}]=\frac{[M]}{[M]}=1\\
[u \cdot \tm]&=[M]\implies [\frac{u \cdot\tw}{\sqrt{-\tw^2}}]= [\frac{u \cdot{\tm}}{\sqrt{-{\tm}^2}}]=\frac{[M]}{[M]}=1\\
[\xi]&=1
\end{aligned}$$
If we call $\frac{1}{\sqrt{-\tw^2}}=\scatlen$ a scattering length[^7] then our dimensionless ratios are :

$$\frac{\comptlen}{\scatlen} \quad \text{and}\quad \scatlen\,\tw \cdot u $$
The delta function can be rewritten as:
$$
\ndeltafn{2 \emom \cdot \tm+\tm^2}=\ndeltafn{2\hbar m\, u\cdot \tw+\hbar^2 \tw^2}=\frac{1}{\hbar m}\ndeltafn{2 \tw \cdot u-\frac{\comptlen}{\scatlen^2}}=\frac{\scatlen}{\hbar m}\ndeltafn{2\scatlen\, \tw \cdot u-\frac{\comptlen}{\scatlen}}
$$







### Notation

As we have now seen the phase space integrals over initial momenta, and over the wavefunctions can be readily eliminated in the classical limit, in which case the momenta   $\emom[1]$ and $\emom[2]$ can be replaced by their classical values. To make explicit that idea we introduce the following notation:



$$
\AAngle{f(\emom[1],\emom[2],\dots)}\coloneq \int\limits \ddP{\emom[1]}\ddP{\emom[2]} \abs{\wf[1](\emom[1])}^2\abs{\wf[2](\emom[2])}^2\,f(\emom[1],\emom[2],\dots)
$$

We can now rewrite @eq-DeltaO:

$$
\changeob = \AAngle{\int \overbracket{\dn[4]{\tm} \ndeltafn{2\emom[1]\cdot \tm +\tm^2}\thetafn{\ct[0]{\emom[1]}+\tm^0}  
                                          \ndeltafn{2\emom[1]\cdot \tm +\tm^2}\thetafn{\ct[0]{\emom[2]}+\tm^0}}^{\dPs{\tm}}
                  \exp{{-\frac{\iunit}{\hbar}}\tm^\mu b_\mu}\pa[\Big]{\vIntp+\rIntp} }
$$

Where 
$$
\begin{aligned}
\vIntp      &=\iunit\,  \obschange{\tm} \amp{\emom[1],\emom[2] }{\emom[1]+\tm,\emom[2]-\tm}\\
\rIntp      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}\obschange{rX-\emom} 
                  \ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
            &\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}} \aamp{\emom[1]+\tm, \emom[2]-\tm }{ r_{1}, r_{2}, r_{X}}
\end{aligned}
$$

Additionally we want to make clear the dependence on $\hbar$ since we want to eventually take the $\hbar \to0$ limit. We can change integration variables to $\tw=\frac{\tm}{\hbar}$ and absorb that $\hbar$ dependence into the redefinition of the integrands:

$$
\begin{aligned}
\dPs{\tm}
&=\hbar^2\dPsb{\tw}
=\hbar^{\cancelto{2}{4}}\dn[4]{\tw} 
\cancel{\frac{1}{\hbar}}\ndeltafn{2\emom[1]\cdot\tw+\hbar\tw^2}
\thetafn{\ct[0]{\emom[1]}+\tm^0}
\cancel{\frac{1}{\hbar}}\ndeltafn{2\emom[1]\cdot \tw +\hbar\tw^2}
\thetafn{\ct[0]{\emom[2]}+\tm^0}
\end{aligned}
$$

$$
\begin{aligned}
\vIntb&=\hbar^2\vIntp\\
\rIntb&=\hbar^2\rIntp
\end{aligned}$$

We can finally neatly write:

$$\Delta O=\AAngle{\int \dPsb{\tw}\exp{-\iunit\tw^\mu b_\mu}\pa[\Big]{\vIntb+\rIntb}}  $$

Now the $\hbar$ dependence is all in the integrands  (ignoring the $\hbar \tw^2$ factors in the delta function). 

We can now explore the integrands in different theories: 




Let us use the \acr{kmoc} framework for \acr{sqed} 

$$\Delta O=\AAngle{\int \dPsb{\tw}\Exp[\Big]{-\iunit\tw^\mu b_\mu}\pa[\Big]{\vIntb+\rIntb}}  $$

Let us take $\ct{\emom[1]}$ as the observable corresponding to the momentum of the first particle.

We then have: 

$$
\begin{aligned}
\vIntb[\ct{\emom[1]}]&=\hbar^2\iunit\,  \tm\, \amp{\emom[1],\emom[2] }{ \emom[1]+\hbar \tw,\emom[2]-\hbar \tw}\\
\rIntb[\ct{\emom[1]}]&=\hbar^2\sumint\ddP[2+\abs{X}]{r_1,r_2,r_X}(r_1^\mu-\emom[1]^\mu)\,\ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
&\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}} \aamp{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{ r_{1}, r_{2}, r_{X}}
\end{aligned}
$$


We can extract $\hbar$ from $\tm$ and from the amplitude, by extracting each $e$ along with an $\frac{1}{\sqrt{\hbar}}$ , thus quartic vertices yield a factor of $\frac{e^2}{\hbar}$ whereas cubic ones yield $\frac{e}{\sqrt{\hbar}}$.  If we count the number $V_3$ of all cubic vertices, and $V_4$ the number of quartic vertices we have that the number of internal lines is $I=\frac{1}{2}(3V_3+4V_4-\energy)$. This is because we have $3V_3+4V_4$  lines to start with, out of which $\energy$ are chosen to be external. The remaining $(3V_3+4V_4-\energy)$ ones are contracted among themselves to form $I$ internal lines. In our case we have $\energy=4+M$ where $M=\abs{X}$ is the number of messenger particles. Using the argument from loop counting we have that the number of loops of our graph $L$ is given by:
$$
\begin{aligned}
        L=I-V+N=&\frac{1}{2}(3V_3+4V_4-4-M)-V_4-V_3+1\\
=&\frac{1}{2}(V_3+2V_4)-1-\frac{M}{2}
\end{aligned}
$$
where $N$ is the number of connected topological space|connected components ($=1$ in our case) . Thus we see that the amount of extracted $\hbar$s corresponds directly to the number of loops plus one! We can thus write the amplitude $\mathcal{A}$ as a sum over reduced $L$-loop amplitudes $\bar{\mathcal{A}}^{(L)}$:

$$\amp{\emom[1],\emom[2]}{ r_1,r_2,X}=\sum\limits_{L=0}^\infty\pa[\Big]{\frac{e^{2}}{\hbar}}^{(L+1+\frac{\abs{X}}{2})}\bar{\mathcal{A}}^{(L)}(\emom[1],\emom[2]\to r_1,r_2,X)$$


Going back to the integrands we have:

$$
\begin{aligned}
\vIntp[\ct{\emom[1]}]&=\hbar^3\iunit\,  \tw\, \sum\limits_{L=0}^\infty\pa[\Big]{\frac{e^{2}}{\hbar}}^{(L+1)}\bar{\mathcal{A}}^{(L)}(\emom[1],\emom[2]\to \emom[1]+\hbar \tw,\emom[2]-\hbar\tw)\\
&=\iunit\,  \tw\, \sum\limits_{L=0}^\infty e^{2(L+1)}{\hbar}^{(2-L)}\bar{\mathcal{A}}^{(L)}(\emom[1],\emom[2]\to \emom[1]+\hbar \tw,\emom[2]-\hbar\tw)
\end{aligned}
$$

as well as the real kernel:[^measurech]

$$
\begin{aligned}
\rIntb[\ct{\emom[1]}]&=\hbar^2\sumint\ddP[\abs {X}]{r_X}\prod\limits_{i=1,2}\dn[4]{w_i}\ndeltafn{2\emom[i] \cdot w_i+w_i^2}\thetafn{\emom[i]^0+w_i^0} \\
&\times w_1^\mu\,\ndeltafn[(4)]{w_1+w_2+r_{X}}
\\
&\times\amp{\emom[1], \emom[2] }{ \emom[1]+w_{1}, \emom[2]+w_{2}, r_{X}} 
\aamp{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{ \emom[1]+w_{1}, \emom[2]+w_{2}, r_{X}}\\
\end{aligned}
$$

$$
\begin{aligned}
=\hbar^2\sumint&\ddP[\abs {X}]{{r}_X}\prod\limits_{i=1,2}\hbar^3\dn[4]{\bar{w}_i}\ndeltafn{2\emom[i] \cdot \bar{w}_i+\hbar\bar{w}_i^2}\thetafn{\emom[i]^0+\hbar \bar{w}_i^0} \\
&\times   \hbar \bar{w}_1^\mu\,\hbar^{-4}\ndeltafn[(4)]{\bar{w}_1+\bar{w}_2+\frac{1}{\hbar}r_{X}}
\\
&\times\sum\limits_{L=0}^\infty\pa[\Big]{\frac{e^{2}}{\hbar}}^{2L+2+\abs{X})}\bar{\mathcal{A}}^{(L)}\pa{\emom[1], \emom[2] \to \emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}} \\
&\times\bar{\mathcal{A^{*}}}^{(L)}{}\pa{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw \to \emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}}
\end{aligned}
$$

$$
\begin{aligned}
=\sumint&\ddP[\abs {X}]{{r}_X}\prod\limits_{i=1,2}\dn[4]{\bar{w}_i}\ndeltafn{2\emom[i] \cdot \bar{w}_i+\hbar\bar{w}_i^2}\thetafn{\emom[i]^0+\hbar \bar{w}_i^0} \\
&\times    \bar{w}_1^\mu\,\ndeltafn[(4)]{\bar{w}_1+\bar{w}_2+\frac{1}{\hbar}r_{X}}
\\
&\times\sum\limits_{L=0}^\infty e^{2(2L+2+\abs{X})}{\hbar}^{3-2L-\abs{X}}\bar{\mathcal{A}}^{(L)}\pa{\emom[1], \emom[2] \to \emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}} \\
&\times\bar{\mathcal{A^{*}}}^{(L)}{}\pa{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw \to \emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}}\\
\end{aligned}
$$

Schematically we have 

$$
\begin{aligned}
\vIntb[\ct{\emom[1]}]&=\sum\limits_{L=0}^\infty \mathcal{O}(e^{2(L+1)})\\
\rIntb[\ct{\emom[1]}]&=\sum\limits_{L=0}^\infty \mathcal{O}(e^{4(L+1)+2\abs{X}})
\end{aligned}
$$

The contributions from the virtual kernel are lower order for a given loop order. Both kernels contribute together provided that the following equation is verified.

$$L-1=2L'+\abs{X}$$

Where $L$ is the loop count for the virtual kernel and $L'$, $\abs{X}$ are the real kernel loop count and messenger particle count respectively.

Now we see that the leading order contribution [^expand]to the impulse $\Delta \emom[1]^{\mu,(0)}$  can only be from the virtual kernel at tree level. Thus we have the following equation.

$$
\Delta \emom[1]^{\mu,(0)}=\AAngle{\int \dPsb{\tw}\Exp[\big]{-\iunit\tw^\mu b_\mu}\ \vIntb[\emom[1]^{\mu}],L=0}
$$

And the integrand is given by the tree level 4 point amplitude.

$$
\vIntp{\emom[1]^{\mu},L=0}=\iunit\,  \tw^\mu\,  e^{2}{\hbar}^{2}\bar{\mathcal{A}}^{(0)}(\emom[1],\emom[2]\to \emom[1]+\hbar \tw,\emom[2]-\hbar\tw)
$$

The amplitude is read off from the single tree level diagram and using feynman rules for SQED. 

$$\iunit\bar{\mathcal{A}}^{(0)}(\emom[1],\emom[2]\to \emom[1]+\hbar \tw,\emom[2]-\hbar\tw)=\iunit \frac{Q_1 Q_2 }{\hbar^2\tw^2}\pa[\big]{4 \emom[1] \cdot \emom[2]+\hbar^2\tw^2}$$

We can now safely take the $\hbar \to 0$ limit as the integrand contains no terms singular in $\hbar$ (the $\frac{1}{\hbar^2}$ is cancelled by the $\hbar^2$ pre-factor). Thus the classical limit is carried out and the final integral to compute is obtained. The integration measure is also simplified in the limit $\lim\limits_{\hbar \to0} \dPsb{\tw}=\dn[4]{\tw} \ndeltafn{2\emom[1]\cdot\tw}\ndeltafn{2\emom[1]\cdot \tw }$[^comp]

$$\Delta \emom[1]^{\mu,(0)}=e^2Q_1Q_2\int\dn[4]{\tw} \ndeltafn{2\emom[1]\cdot\tw}\ndeltafn{2\emom[1]\cdot \tw }\exp{-\iunit\tw\cdot b}\tw^\mu \frac{4 \emom[1] \cdot \emom[2]}{\hbar^2\tw^2}$$

This can be analytically computed (see LO impulse SQED) to find a closed form for the leading order impulse.

$$\Delta \emom[1]^{\mu,(0)}=-\frac{e^{2} Q_{1} Q_{2}}{2 \pi} \frac{\gamma}{\sqrt{\gamma^{2}-1}} \frac{b^{\mu}}{b^{2}}$$

For NLO impulse SQED, using the order equation above we have a 1-loop contribution from the virtual integrand as well as a tree level cut contribution from the real integrand. See NLO impulse SQED for details.
 


[^measurech]: We changed the integration variable from $r_i$ to $w_i=r_i-\emom[i]$ thus the measure changes:$$\ddP[2+\abs{X}]{r_1,r_2,X}=\ddP[\abs {X}]{r_X}\prod\limits_{i=1,2}\dn[4]{w_i}\ndeltafn{2\emom[i] \cdot w_i+w_i^2}\thetafn{\emom[i]^0+w_i^0}$$ where we used the same reasoning as for the $q_i$ variable change.
    
[^expand]: Here the expansion is in powers of the coupling constant, so even though we want $\hbar$s to cancel, the loop order will still affect the order of the contribution through the coupling constant $e$  and the leading order corresponds to $e^2$
[^comp]: Compare to $$\dPsb{\tw}=\dn[4]{\tw} \ndeltafn{2\emom[1]\cdot\tw+\hbar\tw^2}\thetafn{\ct[0]{\emom[1]}+\tm^0} \ndeltafn{2\emom[1]\cdot \tw +\hbar\tw^2}\thetafn{\ct[0]{\emom[2]}+\tm^0}$$ The theta functions cancel as $\tm^0\to0$ and $\emom[i]$ becomes classical.  And as discussed in classical limit of wavefuctions in \acr{kmoc} the integration implicit in the brackets yields new delta functions based on the classical momenta, and with the  $\tw^2$s removed




[^shift]: $f(x)=\int \ddP{\emom} \shellft{f}({\emom})\exp{-\frac{\iunit}{\hbar} \emom^\mu x_\mu}$. Then a shifted, i.e. translated version of $f(x)$ can be written:$$\begin{aligned}f(x-x_0)&=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{-\frac{\iunit}{\hbar} p_\mu (x^\mu-x_0^\mu)}\\&=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{\frac{\iunit}{\hbar}p_\mu x^\mu_0}\,\exp{-\frac{\iunit}{\hbar} p_\mu x^\mu}\end{aligned}$$ Thus the associated, translated state is:$$\ket{f}=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{\frac{\iunit}{\hbar}p_\mu x^\mu_0}\,\ket{\emom }$$

[^complete]: $1=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}\dyad{r_1 r_2 X}$ Where we could consider the states ${r_1,r_2,X}$ to be the final states after the scattering

[^measureshift]: Introducing the momentum shifts modifies the measure in the following way:
    $$\begin{aligned}\ddP{\emom[i]'}&=\ddP{\emom[i]+q_i}\\=&\dn[4]{q_i}\,\ndeltafn{{(\emom[i]+q_i)^2-m_i^2}} \thetafn{{\emom[i]^0+q_i^0}}\end{aligned}$$
            Now since we also have the on shell enforcing delta function from $\ddP{\emom[i]}$ we can rewrite the delta functions:     $$\begin{aligned}\ddP{\emom[i]}&\,\ndeltafn{(\emom[i]+q_i)^2-m_i^2}\\&=\ddP{\emom[i]}\ndeltafn{\underbracket{(\emom[i]^2-m_i^2)}_{\text{redundant}}+2 \emom[i] \cdot q_i+q_i^2}\\&=\ddP{\emom[i]}\ndeltafn{2 \emom[i] \cdot q_i+q_i^2}\end{aligned}$$
            Finally when integrating over $q_2$ we choose to hit $\ndeltafn[(4)]{\emom[1]+\emom[2]-\emom[1]'-\emom[2]'}=\ndeltafn[(4)]{q_1+q_2}$ and thus we just set $q_2=-q_1$

[^constA]: $A$ absorbs the various constants, with $A=\sqrt{2}m\frac{\comptlen}{\ell_\omega}$ and $\tv[0]{x}$ 
[^2]: This means that the classical value of momentum $m_i \breve{u}_i^\mu$ is reached in the $\xi \to 0$ limit
[^3]: This encodes the limit of the spread as $\xi \to0$. $\av{\emom[i]^2}=m_i^2$ is enforced by the measure $\ddP{\emom}$
[^4]: This enforces the normalisation condition $\breve{u}_i^2=1$ in the $\xi \to0$ limit 
[^5]: Here $\tw=\frac{\tm}{\hbar}$ is the wavenumber
[^7]: $[\frac{1}{\sqrt{-\tw^2}}]=[T]=[L]=[\scatlen]$
