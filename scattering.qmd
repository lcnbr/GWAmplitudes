---
editor:
      render-on-save: true
---
# Scattering amplitudes and (?:gw)s {#sec-scat}


::: {.content-hidden unless-format="html"}


{{< include latexmacros.tex >}}
\newcommand{\sumint}{\int\mathllap{\sum}}

:::



Whilst we have almost no hope to detect any (?:gw) scattering events with current experimental apparatuses, the scattering formalism can still be very useful in the quest for orbital waveforms. Most importantly, while experimental data has not been driving *gravitational* scattering theory, the interplay between *particle* scattering experiment and theory have been an enormously fruitful endeavor for the understanding of fundamental interactions in (?:hep). The back and forth between precise measurements (such as those conducted at the (?:lhc) ) and precise predictions for particle scattering, has pushed the boundaries of the calculations possible. It would be therefore very beneficial if one could apply the large knowledge acquired for small non-gravitationally interacting particles, to large compact orbiting bodies. We will see that it is indeed the case.

Such techniques including (?:eft), double copy, generalized unitarity, (?:ibp) reduction, differential equations methods, developed in the context of perturbative computations of collider observables now find an application to the scattering problem in gravity. A key part of applying tools originally developed for quantum systems to problems in gravity is controlling the classical limit, a historically difficult endeavor. Once scattering data is obtained one needs to extract the relevant observables. This may be in an effort to compare results from the different methods, in which case gauge and diffeomorphism, and lorentz invariance are key, since different methods make different gauge and frame choices. It can also be to extract the relevant information for detection and data extraction, in which case the (?:gw) waveform is the relevant observable. In the latter case one is mostly interested in the orbital waveform, and thus a map from unbound to bound orbits is necessary. 

Multiple formalisms have arisen to map the scattering problem to an orbital one, and the quantum formalism to a classical one. One key way is to map scattering data to a potential (as present in a Hamiltonian for example). In fact this has been developped as early as the 1970s in [@Hiida:1972xs;@Iwasaki:1971vb]. Further developments happened in [@Neill:2013wsa;@Bjerrum-Bohr:2013bxa;@Vaidya:2014kza;@Cachazo:2017jef;@Guevara:2017csg;@Damour:2016gwp]. Here we will follow the treatment in [Cheung, Rothstein, and Solon @Cheung:2018wkq], where the conservative part of such scattering amplitudes is matched to an (?:eft) and subsequently to mapped to a potential. Recent efforts to add dissipative effects have also been successful [see @Kalin:2022hph]. This potential can then be used as input to the (?:eob) formalism. Furthermore, [Kalin and Porto @Kalin:2019rwq; @Kalin:2019inp], have shown a path forward in directly extending unbound data to bound orbits, obviating the need to use a potential and (?:eob) at all. 

Finally, as mentioned in the last chapter, scattering can stand on its own and still be usefull without being extended to the orbital case. The (?:pm) approximation can be computed from scattering amplitudes in an (?:eft) framework [@Kalin:2020mvi]. We can also explore the classical observables possible in scattering scenarios. This has been developped in @Kosower:2018adc and was extended to local observables^[local as in not time integrated and thus presenting time dependent dynamics] such as waveforms  in @Cristofoli:2021vyo.


In this chapter we will first look at how to use amplitude data to extract orbital and scattering waveforms. We will then look at the (?:kmoc) formalism to directly extract observables. Finally we will look at how to compute amplitudes, and comparing to results such as those in [@Kosower:2018adc; @Bern:2021xze].

## Scattering amplitudes {#sec-scatamp}     

In (?:qft), to date the only way to encode scattering data is through a scattering amplitude. Consider a process where one starts out with a set of particles described by a state $\ket{i}$, that interact, and yield a final state $\ket{f}$. The scattering amplitude is then defined as the probability amplitude for this process to occur. It is simply given by 
$$\mel{i}{\Smat-1}{f}=(2\pi)^4 \deltafn[(4)]{p_f-p_i}\im \ampl_{fi},$$

where $\Smat$ is the S-matrix, encoding asymptotic time evolution, $\Smat=U_t(-\infty,+\infty)$. We subtract the identity from it, forming what some call the transfer matrix $\Tmat$, as we only are interested in processes where something happens (i.e. not everything stays the same). In the above equation we also define the *scattering matrix element* $\ampl_{fi}$ [see @Srednicki:2007, p. 76] or *invariant Feynman amplitude* [see @Coleman:2018a, p.214], by factoring out a normalised spacetime delta-function that impose the conservation of momentum on the external particles, and a complex unit. The computation of $\ampl$ is made possible by the (?:lsz) [@Lehmann:1954rq;@Collins:2019ozc] formalism, which relates $\ampl_{fi}$ to time-ordered correlation functions (also known as Green's functions) of the given QFT. Green's functions, can be expanded as an infinite sum of diagrams, weighted by a small coupling. The diagrams encode integrals that are obtained by applying Feynman rules which can be readily extracted from an action describing the theory. 

## From amplitude to potential {#sec-amp2pot}

Let us now look at how to map the amplitude to the gravitational potential within the (?:eob) formalism. We will follow the treatment in @Cheung:2018wkq. We start by defining the effective theory that describes our problem: thi orbiting bodies are described by two scalar fields $\wf[1]$ and $\wf[2]$ with masses $\mass[1]$ and $\mass[2]$ interacting through a long range potential $V(r)$. It is the (?:eft) for  non-relativistic fields. This (?:eft) is described by the following action

$$
\action=\int \dd{t} \lag[kin]+\lag[int],
$$

where the kinetic term is given by:

$$
\begin{aligned}
\lag[kin]=&\int \dn[\small \Dim-1]{\tv{k}} \cwf[1](-\tv{k}) \pa[\Big]{\im \partialder[t]-\sqrt{\tv{k}^2+\mass[1]} }\wf[1](\tv{k}),
\\
&+\int \dn[\small \Dim-1]{\tv{k}} \cwf[2](-\tv{k}) \pa[\Big]{\im \partialder[t]-\sqrt{\tv{k}^2+\mass[2]} }\wf[2](\tv{k}),
\end{aligned}
$$

and the interaction term is given by

$$
\lag[int]=  -\int \dn[\small \Dim-1]{\tv{k}} \dn[\small \Dim-1]{\tv{k'}} \pot(\tv{k},\tv{k'}) \cwf[1](\tv{k'}) \cwf[2](-\tv{k'}) \wf[1](\tv{k}) \wf[2](- \tv{k}).
$$

This theory is obtained from the full one by integrating out all the massless force carriers , which are consequently encoded in the potential $\pot(\tv{k},\tv{k'})$ and taking the non-relativistic limit $\abs{\tv{k}},\abs{\tv{k'}}\ll \mass[1,2]$. In a classical system we assume the particles to be separated by a minimum distance, called impact parameter $\abs{\tv{\impactParameter}}$, and consider that their Compton wavelength $\comptlen\sim\inv{\abs{\tv{k}}},\inv{\abs{\tv{k'}}}$^[Note the use of natural units.] is much smaller than this separation,

$$
\abs{\tv{\impactParameter}}\ll \comptlen \simeq \inv{\abs{\tv{k}}},\inv{\abs{\tv{k'}}}.
$$
 
This ensures that the particles are not interacting quantum mechanically in any significant way. Interestingly this hierarchy of scales can be rewritten as:

$$
\tv{J}\sim\abs{\tv{k}\times\tv{\impactParameter}}\gg 1.
$$

Thus, any two body classical system has large angular momentum. We can extract the classical part of any quantity by taking the (?:lo) contribution in the inverse of the angular momentum, or equivalently:

$$
  \inv{J} \propto \inv{\abs{\impactParameter}} \sim \abs{\tv{k}-\tv{k'}}\propto \inv{\kappa},
$$ {#eq-invang}

where $\kappa$ is the coupling constant, which in the case of gravity is $\kappa=4\pi\grav$. For the first relation we used that angular momentum is proportional to separation. We then applied the fact that in scattering scenarios the impact parameter is proportional to the inverse of the momentum transfer  $\sim\inv{\abs{\tv{q}}}$ where :

$$
q=(0,\tv{q})=(0,\tv{k}-\tv{k'}).
$$

The last relation in @eq-invang holds due to the virial theorem. Since the potential must encode the coulomb potential $\kappa/\abs{\tv{k}-\tv{k'}}^2\propto J^3$, it must scale similarly. We thus formulate the following ansatz for the potential:
$$
\pot(\tv{k},\tv{k'})=\sum_{n=1}^\infty \frac{\kappa^n}{\abs{\tv{k}-\tv{k'}}^{\Dim-1-n}} c_n\pa[\Big]{\frac{\tv{k}^2+\tv{k'}^2}{2}}
$${#eq-ansatzpot}

Note that higher order terms in the potential could be formed by any polynomial of momentum invariants $\tv{k}^2$, $\tv{k'}^2$, and $\tv{k}\cdot\tv{k'}$. However, not all combinations of these are independent. The ansatz is chosen such that only the variables $\abs{\tv{k}-\tv{k'}}$ and $\tv{k}^2+\tv{k'}^2$ are present, as the others can be reabsorbed by field redefinitions, or vanish on-shell, such as $\tv{k}^2-\tv{k'}^2$. Note as-well that we work in $\Dim=4-2\dimreg$ dimensions such that the integrals are dimensionally regulated [see @tHooft:1972tcz]. In particular an $\dimreg$-power corresponds to a logarithm^[The third term in the sum is given by $\coupling^3\ln{\tv{k}-\tv{k'}}^2 c_3\pa[\Big]{\Half{\tv{k}^2+\tv{k'}^2}}$.]. Finally, note that in gravity this is precisely a (?:pm) expansion! 


### EFT amplitude 

The first step in establishing determining the potential from a generic scattering amplitude computed in the full theory is to compute the amplitude in the (?:eft). We first identify the Feynman rules from the action. The kinetic term encodes the propagator: 

```{julia}
#| echo: false
#| eval: false
#| output: false
#| fig-align: center
using TikzPictures

tp = TikzPicture(L"""
\matrix 
{    \draw[line width=.3mm,->-=.5,bicolor={red}{blue}] (-1.5,0)  --  (1.5,0) node[midway,above,color=black]{$\displaystyle(k_0,\mathbf{k})$}; &
    \node{$=$}; &
    \node {$\displaystyle\frac{\im}{k_0-\sqrt{\mathbf{k}^2+m_{\textcolor{red}{1}, \textcolor{blue}{2}}^2}+\im 0},$}; \\
  };"""
, options="thick, transform shape",preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings}\\input{../latexmacros.tex}\\usepackage{xcolor}")
save(PDF("./tikz/propagator.pdf"), tp)
save(TEX("./tikz/propagator"; limit_to=:picture), tp)
tp
```

![Propagator rule](tikz/propagator){#fig-propagator}




where the $\im 0$ is the Feynman prescription for avoiding the poles. The interaction term is encoded in the vertex


```{julia}
#| echo: false
#| eval: false
#| output: false 
#| fig-align: center 
using TikzPictures

tp = TikzPicture(L"""


\matrix 
{    \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,anchor node=a] 
{
  {i1} --[->-=.5,thick,"$\displaystyle \mathbf{k}$" font=\large,red]  a[circle,fill,scale=.6] --[->-=.6,thick,"$\displaystyle \mathbf{k'}$" {font=\large},red] o1;
  i2 --[->-=.5,thick,"$\displaystyle -\mathbf{k}$" {font=\large, below,yshift=-5},blue]  a --[->-=.6,thick,"$\displaystyle  - \mathbf{k'}$"  {font=\large, below,yshift=-5,xshift=-5},blue] o2;
};
&
    \node{$=$}; &
    \node {$\displaystyle\im V(\mathbf{k},\mathbf{k'}).$}; \\
  };"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")
save(PDF("./tikz/vertex.pdf"), tp)
save(TEX("./tikz/vertex"; limit_to=:picture), tp)
tp
```

![Vertex rule](tikz/vertex){#fig-vertex} 

The expression for the (?:eft) amplitude will contain the coefficient functions from @eq-ansatzpot since they will be present as vertex terms. Particle number must be conserved in the non-relativistic limit ^[As pair production is kinematically forbidden.], so the amplitude is a sum of bubble diagrams:

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
\matrix{
      \node{$\ampl_\text{EFT}$};&
      \node{$=$};&
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6]  --[->-=.6,thick,blue] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=a to d,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6] --[->-=.6,thick,red] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red,bend right=90] d --[->-=.6,thick,blue] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=a to d,horizontal=i1 to o1,anchor node=a]{
            {i1} --[->-=.5,thick,blue]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6]--[->-=.6,thick,blue,bend left=90] c[circle,fill,scale=.6] --[->-=.6,thick,blue] o1;
            i2 --[->-=.5,thick,red]  a --[->-=.6,thick,red,bend right=90] d--[->-=.6,thick,red,bend right=90] c --[->-=.6,thick,red] o2;};&
      \node{$+$}; &
      \graph[nodes=coordinate, empty nodes,spring layout,horizontal=i1 to o1,horizontal=a to b,anchor node=a]{
            {i1} --[->-=.5,thick,red]  a[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] b[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] c[circle,fill,scale=.6] --[->-=.6,thick,blue,bend left=90] d[circle,fill,scale=.6] --[->-=.6,thick,red] o1;
            i2 --[->-=.5,thick,blue]  a --[->-=.6,thick,red,bend right=90] b --[->-=.6,thick,red,bend right=90] c --[->-=.6,thick,red,bend right=90] d --[->-=.6,thick,blue] o2;};&
      \node{$+$};&
      \node{$\cdots$};
      \\
};"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(PDF("./tikz/eftampl.pdf"), tp)
save(TEX("./tikz/eftampl"; limit_to=:picture), tp)
tp
```

![EFT amplitude](./tikz/eftampl){#fig-eftampl}


We can consequently neatly organise the amplitude into a sum of terms with specific loop counts. We can also equivalently organise it into a sum of terms with specific $\coupling$ powers. We write,

$$\ampl_\text{EFT}=\sum\limits_{L=0}^\infty\ampl[L\text{loop}]_\text{EFT}=\sum\limits_{i=1}^\infty \ampl[(i)]_\text{EFT}.$$

 Notably, these partitions do not line up for the (?:eft) since the vertex contains all powers of the coupling. This is in contrast to the full theory where in fact they yield the same partition. We will eventually want to partition over the coupling power to compare the full theory.

Since every cut of the diagrams contributing to $\ampl_\text{EFT}$ contains two propagators it is useful to define a 2-body propagator. We can integrate over the energy components of the loop momentum, since the vertex does not have an energy dependence:^[The 4-momentum conservation at each vertex means that the energy components of the two propagating momenta must carry along the energy component of the initial state $\energy=\energy[1]+\energy[2]$. This can be encoded by demanding that $\omega_1+\omega_2=\energy$.  Taking the (?:com) frame for the intial momenta means that the 3 momenta of each propagator must cancel i.e. $\tv[1]{k}+\tv[2]{k}=0$]


$$\im \proptwobody{\tv{k}}=\int \dn{\omega} \frac{\im}{\omega-\sqrt{\tv{k}^2+m_1^2}}\frac{\im}{\energy-\omega-\sqrt{\tv{k}^2+m_2^2}}=\frac{\im}{\energy-\sqrt{\tv{k}^2+\mass[1]^2}-\sqrt{\tv{k}^2+\mass[2]^2}},$$

where the integral is performed using the residue theorem, closing the contour in either half plane, where in either case a pole is present. We have define $\energy=\energy[1]+\energy[2]$ to be the (?:com) energy of the  two inital states:^[which is equal to the outgoing energy]

$$
\energy[i]=\sqrt{\tv{p}^2+\mass[i]^2}=\sqrt{\tv{p'}^2+\mass[i]^2},
$$

where $\tv{p}$ and $\tv{p'}$ are the initial and final three-momenta of the two states ^[For example in the initial state one scalar field will have 3-momentum $\tv{p}$, and the other $-\tv{p}$] in the (?:com) frame. Finally, we can write the diagram at loop level $L>0$ encodes:

$$ 
\ampl[L\text{loop}]_\text{EFT}= \int\prod\limits_{i=1}^L  \dn[\small \Dim-1]{\tv[i]{k}} \pot(\tv{p},\tv[1]{k})\proptwobody{\tv[1]{k}}\cdots\proptwobody{\tv[L]{k}}\pot(\tv[L]{k},\tv{p'}).
$$

This integral can be performed in the non-relativistic limit, as done by [Bern et al. @Bern:2019crd] up to 3(?:pm). Up to 2(?:pm), the amplitudes of the (?:eft) is:^[Here the repartioning mentioned above has been applied and a change in loop momenta: $\tv[i]{k}\to\tv{p}+\tv[i]{\ell}$.] 

$$
\begin{aligned}
\ampl[(1)]_\text{EFT}&=-\frac{4\pi\grav c_1}{\tv{q}^2},\\
\ampl[(2)]_\text{EFT}&= \pi^2\grav^2 \Big(-\frac{2 c_2}{\abs{\tv{q}}}+\inv{\energy \redEratio \abs{\tv{q}}}\brc[\Big]{(1-3\redEratio)c_1^2+4\redEratio^2\energy^2c_1 c'_1}\\
                  & \int \dn[\Dim-1]{\tv{\ell}}\frac{32\energy\redEratio c_1^2}{\tv{\ell}^2(\tv{q}+\tv{\ell})^2(\tv{\ell}^2+2\tv{p}\tv{\ell})}\Big),
\end{aligned}
$$

where $\redEratio=\frac{\energy[1]\energy[2]}{\pa{\energy[1]+\energy[2]}^2}$ is the reduced energy ratio. The arguments of the coefficient functions $c_1$ are kept implicit and a prime denotes a derivative with respect to $\tv{\emom}$. Additionally, we defined $\tv{q}=\tv{p'}-\tv{p}$ to be the 3-momentum transfer. 

The key point is that the matching procedure requires the EFT amplitude for two-to-two scattering to be equal to the full amplitude at every order in the coupling constant $\coupling$, i.e. provided we obtain the amplitude of the full theory, and carefully apply the same limiting procedures, we impose that

$$
\ampl[(i)]_\text{EFT}=\ampl[(i)]_\text{full} \quad \forall i.
$$

which fixes the coefficients in the potential ansatz @eq-ansatzpot, and fullfils the promised map from amplitude to potential. Importantly, we must apply the limiting procedure applied above, i.e. the classical and non relativistic limit, which is summarised by the following hierarchy of scales:

$$
\mass[1],\mass[2]\ll J \abs{\tv{q}} \ll \abs{\tv{q}}.
$$

In the full theory this hierarchy is equivalent to restricting to a specific kinematic regime, following the method of regions. We consider all the possible loop-momentum scalings, first due to the classical limit:


| Region | Momentum $\ell = (\omega,\tv{\ell})$ |
| -----: | :----------------------------------: |
|   hard |               $(m,m)$                |
|   soft |  $(\abs{\tv{\tm}},\abs{\tv{\tm}})$   |

In this language, the soft region is responsible for the classical limit, since we consider a small $\abs{\tv{\tm}}$ expansion. We will infact explore this expansion in a different light in @sec-kmoc. Taking the (?:nr) limit corresponds to a subregion of the soft region, the so-called potential region:

$$ (\omega,\tv{\ell})\sim (\abs{\tv{\vel}}\abs{\tv{\tm}},\abs{\tv{\tm}}),$$

where we use that the (?:nr) expansion is a given by $$\abs{\tv{\emom}}\ll m$$ and thus equivalently^[dividing by mass] by a small relative velocity:

$$ \abs{\tv{\vel}}\ll1.$$

To summarise, in order to obtain the form of the potential, we first compute the amplitude in an (?:eft), absorbing all force carrying particles into an effective vertex. Making an ansatz for the potential we can compute the amplitude in the non-relativistic limit in terms of unknown coefficients. This same amplitude can be computed in the full theory, which, as a consequence of the limiting procedure, has simplified kinematic dependence.  The coefficients of the (?:eft) amplitude are then determined by matching it order by order with the full amplitude.

Unfortunately, the procedure described above, and in fact *any* procedure trying to make contact with (?:eob) by expanding the gravitiational potential, intrinsically does not capture the full physics. The crucial point that makes compact binaries interesting is that they are not isolated, energy conserving systems. The energy of the system is lost to the gravitational waves that enable us to detect them. Any conservative dynamics, by construction, cannot capture this loss of energy. In the context of (?:eob), this radiation reaction was added after the fact, through direct modifications of the (?:eom)s obtained from Hamilton's equations. It is not clear how to incorporate dissipative data from the amplitude in the (?:eob) framework. 

One way to not encounter this difficulty is to fully bypass the (?:eob) framework and try to obtain observables directly from the amplitude. This is the subject of the following sections. 








## (>:kmoc) framework {#sec-kmoc}

The (>>>:kmoc) framework (@Kosower:2018adc) is very general, and is aimed at taking the classical limit of a scattering event in an unspecified theory. We will apply it later on  to (?:sqed) and gravity. 

### Conventions

First let us define our conventions. Throughout this section we use relativistically natural units, i.e. we do *not* set $\hbar=1$. This will essentially be the small parameter that multiplies the soft momenta that defined the region in @sec-amp2pot. In this section we will further motivate this classical limit in more detail by taking the generally accepted limit that makes quantum physics collapse to classical physics

$$\hbar\to0.$$ 

We still retain $c=1$, meaning that, using dimensional analysis we have that $[L][T]^{-1}=1$ i.e. $[L]=[T]$,  length and time are measured in the same units. Correspondingly, energy is measured in units of mass
$$
\energy=mc^2\implies[\energy]=[m]=[M],
$$ 

and $\hbar$ has the following units

$$
\energy=\hbar \omega\implies [M]=[\hbar][T]^{-1}\implies [\hbar]=[T][M]
.$$ 

Thus momentum $\emom$ has units of $[\emom]=[M]$ mass and Wavenumber $[\bar{\emom}]=[\frac{\emom}{\hbar}]=[T]^{-1}$ has units of inverse time. 
We will denote the Lorentz-invariant phase space measure by $\ddP{p}$^[Repeated integration will be denoted $\ddP[n]{p_1,\dots,p_n}$]:

$$
\int \ddP{p} \dots      = \int \frac{\dd[3]{\tv{p}}}{2\hbar\shellen (2\pi)^3} \dots = \int \dn[4]{p}\nposendelta[-m^2]{p} \dots,
$$

where quantities denoted by bars absorb the relevant factors of $2\pi$, such that $\dn[n]{p}=\frac{\dd[n]p}{(2\pi)^n}$. Additionally, we have defined $\hbar\shellen=\sqrt{\tv{p}^2+m^2}$ to be the on-shell energy and  $\delta^{(+)}$ is the normalised positive energy on-shell delta function:

$$
\nposendelta[-m^2]{p}=(2\pi)\deltafn{\lv{p}^2-m^2}\thetafn{\ct[0]{p}}=\ndeltafn{\lv{p}^2-m^2}\thetafn{\ct[0]{p}}
$$

### Intital State

With our conventions at hand, let us set the stage for the problem. Imagine we want to scatter two particles, be they massive black holes, or tiny electrons, into each other, with a constant particle number (i.e. a classical two in two out scattering). As mentioned in @sec-scatamp, in (?:qft) the framework that formalizes scattering of definite particle number states is based on the (?:lsz) reduction formula. 

[we work in the Heisenberg picture here]{.aside}

Let us look at it in more detail. The first step is to define the states we want to scatter. Suppose our theory has single particle states $\momket$, with mass $\mass$, eigenstates of the momentum:

$$\ct{\momop}\momket=\ct{\emom}\momket \quad \text{with} \quad p^0=\hbar\shellen=\sqrt{\tv{\emom}^2+\mass^2}.$$

These states can be seen as special cases (the plane wave states) of wavepacket states:^[A plane wave state $\ket{f}=\momket$ would be given by $\shellft{f}(k)=2 \hbar\shellen[\tv{k}]  \ndeltafn[(3)]{\tv{k}-\tv{p}}$]

$$\ket{f}=\int \ddP{k} \shellft{f}(k) \momket[k],$$

where $\shellft{f}(k)$ is the momentum space wavefunction or, more mathematically, the momentum distribution function. Note that it is almost a Fourier transform, but not quite, as it is performed on the mass shell. If the spacetime 'wavefunction' ^[Note that the concept of coordinate space wavefunction is ill defined in interacting theories. However for such asymptotic states, the wavefunction outside the bulk (on the infinte time boundary) is that of a free wavefunction.] is given by

$$f(x)=\int \ddP{k} \shellft{f}(k) \exp{-\im\lv{k}\cdot\lv{x}},$${#eq-spacetimewf}

so that $\shellft{f}(k)$ is consequently given by

$$\ip{k}{f}=\shellft{f}(k)= 2 \hbar\shellen \int \dd[3]{\tv{x}}f(x) \exp{\im k\cdot x}.$${#eq-momdist}


If we now define the following operators^[$f\lrder g=f\pa{\partialder[\mu]g}-\pa{\partialder[\mu]f}g$]
^[
Note that if we replace $f(x)$ by a plane wave state  $\exp{-\im k\cdot x}$ we obtain and define the following:

$$
\createop[\tv{k}](t)=  \int \dd[3]{\tv{x}} \exp{-\im k\cdot x} \brc[\Big]{\hbar\shellen[\tv{k}]\wf(x)-\im \partialder[0]\wf(x)},
$$

$$
\annihilop[\tv{k}](t)=   \int \dd[3]{\tv{x}} \exp{\im k\cdot x} \brc[\Big]{\hbar\shellen[\tv{k}]\wf(x)+\im \partialder[0]\wf(x)},
$$

]

$$
\createop[f](t)= -  \im \int \dd[3]{\tv{x}}f(x) \lrder[0] \scf(x),
$$

$$
\annihilop[f](t)=   \im \int \dd[3]{\tv{x}}\conj{f}(x) \lrder[0] \scf(x),
$$

where $\scf(x)$ is the Heisenberg field operator of our theory. While these operators are time dependent, this dependence is not obtained from applying the Heisenberg (?s:eom) ^[$\odv{A_H(t)}{t}=\im\com{H_H}{A_H(t)}$], instead it is present through the time dependence of the wavefunction $f(x)$. It turns out that these operators, suggestively written are the true creation and annilihation operators in the interacting theory. 

We can now define a general one particle state $\ket{f}$ as the result of a creation operator acting on the physical vacuum. Crucially, this only makes sense in the boundary of the bulk, i.e. at asymptotic times $t\to\pm\infty$^[See @Coleman:2018a or @Collins:2019ozc for a more in depth discussion of this point]. Inside the bulk, any thusly created state would infact not have definite particle number. This definitely makes sense in the scattering problem because if you consider the whole system as a state, it only has definite particle number at asymptotic times, and inside the bulk the scattering happens, and the particle number is not conserved (at least quantum mechanically). 

Consequently, we only define asymptotic states, denoting them by an $\text{in}$ subscript if they were created at $t\to-\infty$ and $\text{out}$ if they were created at $t\to+\infty$:

$$ 
\ket[in]{f}\defeq\lim_{t\to-\infty}\createop[f](t)\physvack=\createop[f;\text{in}]\physvack=\int \ddP{k} \shellft{f}(k) \underbracket{\createop[\tv{k}]\physvack}_{\momket[k]}
$$

and the corresponding $t \to +\infty$ state where in is replaced with out. It turns out that the extension to multiparticle states is not much more complicated. The one thing to demand is that the momentum distributions say $\shellft{f_1},\shellft{f_2},\dots$ have no common support, i.e. they are not overlapping. In this case an n-particle in state is defined as: 

$$
\ket[in]{f_1,\dots,f_n}\defeq\createop[f_1;\text{in}]\createop[f_2;\text{in}]\dots\createop[f_n;\text{in}]\physvack=\int \ddP[n]{k_1,\dots,k_n} \shellft{f_1}(k_1)\dots\shellft{f_n}(k_n) \momket[k_1,\dots,k_n]. 
$$

We now have the definitions for asymptotic in and out states for any number of particles. Before defining the setup to scatter two particles, let us look at the meaning of the position space wavefunction $f(x)$ as defined in @eq-spacetimewf. Consider a sharply peaked, compactly supported momentum distribution $\shellft{f}(k)$ around a value $\tv[0]{p}$ and a characteristic width $\Delta p$. One such function could be:

$$
f\pa{\tv{p} ; \tv[0]{p}, \Delta p}=\left\{\begin{array}{ll}
N \exp{-1 /\pa{1-\abs{\tv{p}-\tv[0]{p}}^2 / \Delta p^2}} & \text { if }\abs{\tv[0]{p}-\tv{p}}<\Delta p \\
0 & \text { if }\abs{\tv[0]{p}-\tv{p}} \geq \Delta p
\end{array}\right.,
$${#eq-peak}



where $N$ is a normalization constant. The integrand in @eq-spacetimewf, at large $t$ or $\tv{x}$, will be dominated by the stationary phase point $\tv[s]{p}$ which is given by:^[This then means that $$\tv[s]{p}=\frac{\mass\tv{x}\sign{t}}{\sqrt{t^2-\tv{x}^2}}$$ thus $$\hbar\shellen[{\tv[s]{p}}]=\frac{\mass\abs{t}}{\sqrt{t^2-\tv{x}^2}}$$]

$$0=-\pdv{}{\tv[s]{p}}\pa{\hbar\shellen[{\tv[s]{p}}]t+\tv[s]{p}\cdot\tv{x}}=-\frac{\tv[s]{p}t}{\hbar\shellen[{\tv[s]{p}}]}+\tv{x}.
$${#eq-stationaryphase}

In the case of a sharply peaked momentum distribution, the coordinate space wavefunction will be largest when the stationary phase point is the same as the peak of the momentum distribution, i.e. $\tv[s]{p}=\tv[0]{p}$ i.e. substituting $\tv[s]{p}$ into  @eq-stationaryphase gives:
$$
\tv{x}\simeq \frac{\tv[0]{p}t}{\hbar\shellen[{\tv[0]{p}}]}=\tv[0]{v}t.
$$

This is precisely the trajectory of the classical relativistic particle. Now consider the case of two particles with different peaked momentum distributions their trajectories will have different velocities, but the same positions at time $0$. Thus we will shift one of these trajectories by a so called impact parameter $\ct{\impactParameter}$[^shift], parametrising the relative separtation of the two particles/wavepackets. This can be simply done by multiplying the momentum distribution $\shellft{\wf[1]}(p)$ by a factor of $\exp{\frac{\im}{\hbar} \impactParameter \cdot p}$. We take it to be perpendicular to the initial momenta $\emom[1],\emom[2]$. We now can write down the initial state that we are going to study:

$$
\ket{\text{in}}=\int \ddP[2]{\emom[1],\emom[2]} \shellft{\wf[1]}(\emom[1]) \shellft{\wf[2]}(\emom[2]) \exp{\frac{\im}{\hbar} \co{\impactParameter} \ct{\emom[1]}}\ket[in]{\emom[1],\emom[2]}.
$$ {#eq-instate}


From now on we will drop the breve and infer from the arguments the type of $\wf$ we are dealing with. Observe that by extracting the impact parameter in this way, the wavefunctions can be identitcal in form, and will still be separated as required.

### Change in observable

The (?:kmoc) framework concerns itself with the change of an observable quantity during a scattering event encoded in an operator $\op{O}$. For such an observable quantitiy $\obs{O}$ , its change is  obtained by evaluating the difference of the expectation value of $\op{O}$, between in and out states
$$
\Delta O=\ev{\op{O}}{\text{out}}-\ev{\op{O}}{\text{in}}.
$$

In quantum mechanics, the out states are related to the in states by the time evolution operator, i.e. the S-matrix, $\ket{\text{out}}=\Smat \ket{\text{in}}$. Thus: 

::: {.aside}
In order, we use the unitarity of the S-matrix, then express the S-matrex as the identity (no actual interaction) and the transfer matrix $\Tmat$. The commutators are then expanded and the part with the identity vanish (as $\id$ commutes with everything). 
:::

$$
\begin{aligned}
\Delta O    &=\ev{\adj{\Smat}\op{O}\Smat}{\text{in}}-\ev{\op{O}}{\text{in}}\\
            &\stackrel{\adj{\Smat} \Smat=\id}{=}      \ev{\adj{\Smat} \com{\op{O}}{\Smat}}{\text{in}}\\
            &\stackrel{\Smat=\id+\im \Tmat}{=}          \ev{\com{\op{O}}{\id+\im \Tmat}}{\text{in}}
                                                      -\ev{\im \adj{\Tmat} \com{\op{O}}{\id+\im \Tmat}}{\text{in}}\\
            &=    \ev{\im\com{\op{O}}{\Tmat}}{\text{in}}
                  +\ev{ \adj{\Tmat} \com{\op{O}}{\Tmat}}{\text{in}}\\
            &=\vchangeob+\Delta O_\text{r}.
\end{aligned}
$${#eq-DeltaO}


If we put in the definition of our in state (@eq-instate), we have


$$
\Delta O = \int \ddP[4]{\emom[1],\emom[2],\emom[1]',\emom[2]'} 
                  \wf[1](\emom[1]) \wf[2](\emom[2]) \cwf[1](\emom[1]') \cwf[2](\emom[2]')
                  \,\exp{\im \co{\impactParameter} \frac{\ct{\emom[1]}-\ct{\emom[1]'}}{\hbar}}
                  \brc[\big]{\vInt-\rInt},
$$

where we defined the real integrand $\rInt$ and the virtual integrand $\vInt$ as the following matrix elements ^[NB: the notation is slightly different in the @Bern:2021xze paper]

$$
\begin{aligned}
\vInt &=\bra[in]{\emom[1]'\emom[2]'}{\im\com{\op{O}}{\Tmat}           }\ket[in]{\emom[1]\emom[2]}\\
\rInt &=\bra[in]{\emom[1]'\emom[2]'}{\adj{\Tmat}\com{\op{O}}{\Tmat}   }\ket[in]{\emom[1]\emom[2]}.
\end{aligned}
$$



Let us first look at the virtual integrand $\vInt$:^[Here we define $$\obs{O}_{\text{in}}\ket{\emom[1]\emom[2]}=\op{O}\ket{\emom[1]\emom[2]}$$ aswell as, $$\obs{O}_{\text{in}}'\bra{\emom[1]'\emom[2]'}=\bra{\emom[1]'\emom[2]'}\op{O}$$ and finally $$\obschange{\emom'-\emom}=\obs{O}_{\text{in}}'-\obs{O}_{\text{in}}$$]

$$
\begin{aligned}
\vInt &=\bra[in]{\emom[1]'\emom[2]'}{\im\com{\op{O}}{\Tmat}     }\ket[in]{\emom[1]\emom[2]}  \\
      &=\bra[in]{\emom[1]'\emom[2]'}{\im\op{O}\Tmat             }\ket[in]{\emom[1]\emom[2]}   
      - \bra[in]{\emom[1]'\emom[2]'}{\im \Tmat\op{O}            }\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obs{O}_{\text{in}'}  \; \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}
      - \im \obs{O}_{\text{in}} \;    \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obschange{\emom'-\emom} \,    \bra[in]{\emom[1]'\emom[2]'}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\im \obschange{\emom'-\emom}\,\ndeltafn[4]{\emom[1]+\emom[2]-\emom[1]'-\emom[2]'} 
                                    \amp{\emom[1],\emom[2]}{\emom[1]',\emom[2]'}.
\end{aligned}
$$ {#eq-vInt}

Note that the amplitude is from in states to in states. In order to obtain the real integrand $\rInt$, we insert a complete set of states :[^complete]

$$
\begin{aligned}
\rInt &=\bra[in]{\emom[1]'\emom[2]'}{\adj{\Tmat}\com{\op{O}}{\Tmat}}\ket[in]{\emom[1]\emom[2]}\\
      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}   \bra[in]{\emom[1]'\emom[2]'}\adj{\Tmat}\vert{r_1 r_2 X}\rangle\langle {r_1 r_2 X} \vert
                        \com{\op{O}}{\Tmat}\ket[in]{\emom[1]\emom[2]}\\
      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}  \ndeltafn[4]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}}\,
      \amp{\emom[1], \emom[2]}{r_{1}, r_{2}, r_{X}} \\
      &\qquad \obschange{rX-\emom}\,\ndeltafn[4]{\emom[1]'+\emom[2]'-r_{1}-r_{2}-r_{X}}\,
      \aamp{\emom[1]', \emom[2]'}{r_{1}, r_{2}, r_{X}},
\end{aligned}
$$ {#eq-rInt}

where the $X$ encodes any number of additional messenger states, and $r_{X}$ is the sum of their momenta. For both integrands we can preform some variable changes and eliminate certain Dirac delta functions. We introduce momentum shifts $q_i=\emom[i]'-\emom[i]$ and then integrate over $q_2$, and finally relabel $q_1 \to \tm$   [^measureshift]. Thus we have

$$
\begin{aligned}
\vchangeob=\int &\ddP[2]{\emom[1],\emom[2]} \dn[4]{\tm}
      \ndeltafn{2 \emom[1] \cdot \tm+\tm^2} \thetafn{\ct[0]{\emom[1]}+\tm^0}\, \ndeltafn{2 \emom[2] \cdot \tm-\tm^2} \thetafn{\ct[0]{\emom[2]}-\tm^0}\\
      &\times\wf[1](\emom[1])\wf[2](\emom[2])\cwf[1](\emom[1]+\tm)\cwf[2](\emom[2]-\tm)\,\exp{-\frac{\im}{\hbar} \co{\impactParameter} \tm^\mu}\\
      &\times \im \obschange{\tm} \amp{\emom[1],\emom[2] }{\emom[1]+\tm,\emom[2]-\tm},
\end{aligned}
$${#eq-DeltaOv}


$$
\begin{aligned}
\rchangeob=\sum\limits_X \int &\ddP[2+\abs{X}]{r_1, r_2,X}
      \ddP[2]{\emom[1],\emom[2]} \dn[4]{\tm} \ndeltafn{2 \emom[1] \cdot \tm+\tm^2} \thetafn{\ct[0]{\emom[1]}+\tm^0}\\
            &\times \ndeltafn{2 \emom[2] \cdot \tm-\tm^2} \thetafn{\ct[0]{\emom[2]}-\tm^0}\\
            &\times\wf[1](\emom[1])\wf[2](\emom[2])\cwf[1](\emom[1]+\tm)\cwf[2](\emom[2]-\tm)\,\exp{-\frac{\im}{\hbar} b_\mu \tm^\mu}\\
            &\times\obschange{rX-\emom}\ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
            &\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}}\aamp{\emom[1]+\tm, \emom[2]-\tm }{r_{1}, r_{2}, r_{X}}.
\end{aligned}
$${#eq-DeltaOr}

We have arrived at an integral expression for the change in observable $\Delta\obs{O}$. Luckily for us, we will not need to perform these integrals in the classical limit. We will just have carefully chosen replacement rules for the integrated variables! Let us look at this in more detail now.



### Classical limit

Since we are concerned with classical observables, we need to explore the classical limit of @eq-DeltaO, i.e. the limit of $\hbar \to 0$. We first discuss the classical limit of wavefunctions. We impose multiple conditions on the wavefunctions. The first are those imposed by (?:lsz) reduction. That is,

- Compact support momentum space wavefunction
- Peaked around one value of momenta

Furthermore the classical limit of the wavefunctions should make sense, i.e. 

1. as $\hbar \to 0$ the position and momentum wavefunction should approach Dirac delta functions, centered around their classical values.
3. The overlap between the wavefunction and its conjugate should be nearly full, since they represent the same particle classically.

Consider for example a nonrelativistic wavefunction for a particle of mass  $\mass$:

$$
f(\tv{\emom})=\Exp[\Big]{-\frac{\abs{\tv{\emom}}}{2 \hbar m \comptlen/\wfwidth^2}}\stackrel{\hbar=\comptlen m}{=}\Exp[\Big]{-\frac{\abs{\tv{\emom}}}{2 m^2 \comptlen^2 /\wfwidth^2}},
$$

where $\comptlen=\frac{\hbar}{m}$ is the compton wavelength of the particle and $\wfwidth$ is a  characteristic width. This wavefunction, with the proper normalization, grows sharper in the $\hbar \to 0$ limit. If we now take the Fourier transform of $f(\tv{\emom})$ to obtain the position "probability density", we have:[^constA]
$$
\begin{aligned}
\invFT[\tv{\emom}]{f}{\tv{x}}(\tv{x})   &=\int \frac{\dd{\tv{\emom}}}{2 \pi} \Exp[\Big]{-\pa[\big]{\frac{\tv{\emom}}{A}}^2}\Exp[\Big]{-\frac{\im}{\hbar} \tv{\emom}\cdot \tv{x}}\\
            &=\frac{1}{2\pi}\underbracket{\int \dd{\tv{\emom}} \Exp[\Big]{-\pa[\Big]{\frac{\tv{\emom}}{A}-\frac{\im\tv{x}A}{2 \hbar}}^2}}_{\sqrt{\pi}A}\Exp[\Big]{- \frac{\tv{x}^2A^2}{4 \hbar^2}}\\
      &=\frac{\sqrt{2}A}{2 \pi}\Exp[\Big]{-\frac{\tv{x}^2}{2 \wfwidth^2}}.
\end{aligned}
$$

This elucidates more clearly the meaning of characteristic width, as $\wfwidth$ is the standard deviation of the wavefunction in position space. Thus, the position-space wavefunction grows sharper in the $\wfwidth^2 \to 0$ limit. For both wavefunctions to simultaneously grow sharper in the classical limit, we must then have that $\xi=\pa{\frac{\comptlen}{\wfwidth}}^2\to0$ remembering that the $\hbar \to 0$ limit is just given by the $\comptlen\to0$ one. Finally the meaning of classical limit in this context is the $\xi \to 0$ limit. 


Going back to the general conditions, we want a wavefunction $\wf[i](\emom[i])$ such that in the classical limit the momentum reaches its classical value: $\cls{\emom[i]}=\mass[i]\cls{\vel[i]}$, with $\cls{\vel[i]}$ the classical four-velocity of particle $i$, normalized to $\cls{\vel[i]}^2=1$. In other words,

$$
\av{\ct{\emom[i]}}=\int \ddP{\emom[i]} \ct{\emom[i]} \abs{\wf[i](\emom[i])}^2\stackrel{!}{=}m_i \breve{u}_i^\mu (1+\order[\beta']{\xi}),
$$

where $\beta'$ encodes the speed at which the classical value is reached in the $\xi\to0$ limit. The velocity normalization convergence is controlled by $\beta''$
$$\breve{u}_i \cdot u_i = 1+ \order[\beta'']{\xi},$$

Finally wavefunction's spread is controlled by $\beta$, and must converge to 0:
$$\begin{aligned} \sigma^2(\emom[i])/m_i^2&=\inv{m_i^2}\av{(\emom[i]-\av{\emom[i]})^2}\\&=\inv{m_i^2}(\av{\emom[i]^2}-\av{\emom[i]}^2)\\&=\inv{\mass[i]^2}(\mass[i]^2-(\mass[i]\cls{\vel[i]}(1+\order[\beta']{\xi}))^2)
\\&\propto\xi^\beta,\end{aligned}$$

where $\av{\emom[i]^2}=m_i^2$ is enforced by the measure $\ddP{\emom}$. 

Additionally, the wavefunction should be Lorentz invariant, and naively we would have that $\wf(\emom[i]^\mu)=\wf'(\emom[i]^2)$. However the integration measure enforces an on-shell condition: $m_i^2=\emom[i]^2$. Thus the wavefunction cannot depend on $\emom[i]^2$, and we need to introduce at least one additional four vector parameter $u$. The simplest dimensionless combination of parameters it then $\frac{\emom \cdot u }{m}$. Of course the wavefunction must also depend on $\xi$ and the simplest form of argument will thus be $\frac{\emom \cdot u }{m \xi}$ so that any $\emom$ not aligned with $u$ will be strongly suppressed in the $\xi \to0$ limit.

We now have control over most of the conditions:

- The classical limit is well defined
- The wavefunction spread is controlled
- The arguments of the wavefunction are clear

We can write a general wavefunction that satisfies the above as:

$$
f(\frac{\emom \cdot u }{m}\vert\cls{\vel[i]};\mass[i] ;\beta^{(i)}).
$$

This function can take the form of a gaussian, or something similar to @eq-peak. Now there is one final requirement, that concerns the overlap of $\wf$ and $\cwf$ must be $\mathcal{O}(1)$, equivalently and more precisely:

$$
\cwf(\emom+\tm)\sim \cwf(\emom) \implies \cwf(\emom+\tm)- \cwf(\emom)\ll 1 \implies \ct{\tm}\pdv{}{\ct{p}}\cwf(\emom)\ll1.
$$
Making explicit the $\frac{\emom \cdot u }{m \xi}$ dependence: $\wf(\emom)=\varphi(\frac{\emom \cdot u }{m \xi})$   for $\varphi(x)$ a scalar function.
$$\implies \frac{\ct{\tm} u_\mu}{m \xi}\odv{\varphi^*(x)}{x}\Bigr|_{\frac{\emom \cdot u }{m \xi}}\ll  1.$$

Thus we require that for a characteristic value of $\tm=\co[0]{\tm}$ we have:

$$
\frac{\co[0]{\tm}\cdot u}{m \xi}=\co[0]{\tw} \cdot u\frac{\wfwidth^2}{\comptlen}\ll1\iff \co[0]{\tw} \cdot u\,\wfwidth\ll \sqrt{ \xi},
$$

having we denoted by a bar any quantity that has been rescaled by $\hbar$. Thus, a momentum $\emom$, when divided by $\hbar$ will be written $\bar{\emom}$ and called wavenumber. We will combine this inequality with ones we obtain from the specific cases of integrations required above. 

We now want to examine the classical limit of the integrands of the form @eq-DeltaOv. If we consider just the integration over the initial momenta $\emom[i]$ and the initial wavefunctions with $\ndeltafn{2 \emom[i] \cdot \tm+\tm^2}$, the delta function will smear out to a sharply peaked function whose scale is of the same order as the original wavefunctions. As $\xi$ gets smaller, this function will turn back into a Dirac delta function imposed on the $\tm$ integration. Let us examine this statement more closely. We are interested in the classical limit of the integrals such as:


$$
d(m,\xi,u,\tm)=\int \ddP{\emom} \ndeltafn{2 \emom \cdot \tm+\tm^2} \thetafn{\emom^0+\tm^0}\varphi \pa[\Big]{\frac{\emom \cdot u }{m \xi}}\varphi^*\pa[\Big]{\frac{(\emom+\tm) \cdot u }{m \xi}}.
$${#eq-dfunct}


This integral must be Lorentz invariant and depends on $m,\xi, u,\tm$ thus it must manifestly only depend on the following Lorentz invariants: $u^2,\tm^2,u \cdot \tm, \xi$. One of these is not actually a variable as we will normalise $u^2=1$. The rest are not fully dimensionless, but we can render them dimensionless:

$$
\begin{aligned}
\brc{\tm^2} &=[\hbar \tw]^2=[M]^2\implies[\comptlen \sqrt{-\tw^2}]=[\frac{\hbar}{m}\sqrt{-\tw^2}]=\frac{[M]}{[M]}=1,\\
[u \cdot \tm]&=[M]\implies [\frac{u \cdot\tw}{\sqrt{-\tw^2}}]= [\frac{u \cdot{\tm}}{\sqrt{-{\tm}^2}}]=\frac{[M]}{[M]}=1,\\
[\xi]&=1.
\end{aligned}
$$

If we call $\frac{1}{\sqrt{-\tw^2}}=\scatlen$ a scattering length[^7] then our dimensionless ratios become :

$$\frac{\comptlen}{\scatlen} \quad \text{and}\quad \scatlen\,\tw \cdot u .$$

The Dirac delta function can then be rewritten as:
$$
\ndeltafn{2 \emom \cdot \tm+\tm^2}=\ndeltafn{2\hbar m\, u\cdot \tw+\hbar^2 \tw^2}=\frac{1}{\hbar m}\ndeltafn{2 \tw \cdot u-\frac{\comptlen}{\scatlen^2}}=\frac{\scatlen}{\hbar m}\ndeltafn{2\scatlen\, \tw \cdot u-\frac{\comptlen}{\scatlen}}.
$$

Performing the integration over $\emom$ in @eq-dfunct we obtain symbolically:

$$
d(m,\xi,u,\tm)=\text{peaked function imposing that } {2\scatlen\, \tw \cdot u=\frac{\comptlen}{\scatlen}}\text{ with width } \xi^\beta.
$$







```{julia}
#| echo: false
#| label: fig-gaussian
#| fig-cap: "Sharpening gaussian"
#| column: margin
using Plots

function delta(x)
    if abs(x)<1e-3
        return 1
    else
        return 0
    end
end

function gauss(x)
    return exp(-x^2)
end

function sharpen(f,eps,power)
    return x->f(x/eps^power)/eps^power
end

epss=0.02:0.01:0.1



p=plot([sharpen(gauss,eps,1) for eps in epss], -0.5,0.5,label=epss')
```


Let us disucss the wavefunction and the scales from a physical perspective. The characteristic width $\wfwidth$ is the particle's position uncertainty, $\frac{\hbar}{\wfwidth}$ is the associated momentum uncertainty. In the classical limit the position uncertainty is neglible with respect to minimum distance between the particles $\scatlen$:

$$
\wfwidth\ll \scatlen,
$$

and the momentum uncertainty is neglible with respect to the masses of the particles:

$$
\frac{\hbar}{\wfwidth}\ll m \implies \comptlen\ll \wfwidth.
$$

Putting these together we obtain the goldilocks inequality:

$$
\comptlen\ll\wfwidth\ll\scatlen.
$$

Looking back at the arguments of $d$ we see that 

$$
\scatlen\, \tw \cdot u\gg\wfwidth \tw \cdot u \sim \sqrt{\xi} =   \frac{\comptlen}{\wfwidth}\gg\frac{\comptlen}{\scatlen}.
$$

Thus in the classical limit we have that $d$ collapses to:

$$
d(m,\xi,u,\tm)\propto\ndeltafn{ \tw \cdot u}.
$$

Thus, the wavefunction-weighted on-shell phase-space integration disappears in the classical limit. The resulting condition is that the integration momenta take on their physical values. The sequence that we have gone through should be done for all the integrands of type $d$. We will not do this explicitly every time but instead apply the following rules:

1. Just as for the massless transfer momentum any messenger momentum, be it transfer, virtual-loop or real emmission, shall become a wavenumber: $k\to \hbar \bar{k}$. 
2. Replace all couplings with their dimensionless counterparts: $\coupling\to \frac{\coupling}{\sqrt{\hbar} }$ (this is only precisely true for (?:sqed) and gravity, which are the applications we are interested in).
2. Eliminate all on-shell integrations by approximating $\wf(\emom+\hbar\tw)$ by $\wf(\emom)$.
3. Laurent expand all the integrands in $\hbar$.
3. Make the integration momenta take on their physical values: $\emom[i]\to \mass[i]\cls{\vel[i]}$.

To make this idea explicit we introduce the following notation, meaning that the steps above have been applied


$$
\AAngle{g(\emom[1],\emom[2],\dots)}\defeq \int\limits \ddP{\emom[1]}\ddP{\emom[2]} \abs{\wf[1](\emom[1])}^2\abs{\wf[2](\emom[2])}^2\,g(\emom[1],\emom[2],\dots)
$$

We can now rewrite @eq-DeltaO

$$
\changeob = \AAngle{\int \overbracket{\dn[4]{\tm} \ndeltafn{2\emom[1]\cdot \tm +\tm^2}\thetafn{\ct[0]{\emom[1]}+\tm^0}  
                                          \ndeltafn{2\emom[2]\cdot \tm -\tm^2}\thetafn{\ct[0]{\emom[2]}+\tm^0}}^{\dPs{\tm}}
                  \exp{{-\frac{\im}{\hbar}}\tm^\mu b_\mu}\pa[\Big]{\vIntp+\rIntp} },
$$ {#eq-DeltaOclas}

where 
$$
\begin{aligned}
\vIntp      &=\im\,  \obschange{\tm} \amp{\emom[1],\emom[2] }{\emom[1]+\tm,\emom[2]-\tm}\\
\rIntp      &=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}\obschange{rX-\emom} 
                  \ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
            &\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}} \aamp{\emom[1]+\tm, \emom[2]-\tm }{ r_{1}, r_{2}, r_{X}}.
\end{aligned}
$$

Additionally, we make clear the dependence on $\hbar$ since we want to eventually take the $\hbar \to0$ limit. We apply step 1. above, and change integration variables to $\tw=\frac{\tm}{\hbar}$ and absorb the $\hbar$ dependence into the redefinition of the integrands and the measure:

$$
\begin{aligned}
\dPs{\tm}
&=\hbar^2\dPsb{\tw}
=\hbar^{\cancelto{2}{4}}\dn[4]{\tw} 
\cancel{\frac{1}{\hbar}}\ndeltafn{2\emom[1]\cdot\tw+\hbar\tw^2}
\thetafn{\ct[0]{\emom[1]}+\tm^0}
\cancel{\frac{1}{\hbar}}\ndeltafn{2\emom[1]\cdot \tw +\hbar\tw^2}
\thetafn{\ct[0]{\emom[2]}+\tm^0},
\end{aligned}
$$

$$
\begin{aligned}
\vIntb&=\hbar^2\vIntp,\\
\rIntb&=\hbar^2\rIntp.
\end{aligned}$$

We can finally neatly write:

$$\Delta O=\AAngle{\int \dPsb{\tw}\exp{-\im\tw^\mu b_\mu}\pa[\Big]{\vIntb+\rIntb}}  .$$

The $\hbar$ dependence is now entirely contained in the integrands  (ignoring the $\hbar \tw^2$ factors in the delta function). The classical limit of this observable is then simply, 

$$
\Delta O_{\text{classical}}=\lim_{\hbar\to0}\hbar^{\beta_{LO}}\brc[\Big]{\int \dPsb{\tw}\pa[\Big]{\vIntb+\rIntb}},
$$
 
dropping the angle brackets, since these dissappear in the classical limit. Here $\beta_{LO}$ is the (?:lo) $\hbar$-dependence of the observable. This is so that $\Delta O_{\text{classical}}\sim\hbar^0$ i.e. classical scaling.


## Impulse in (?:kmoc)



We can now explore the integrands for a specific observable. Consider the change in momentum, or impulse of particle 1. The (?:kmoc) formalisms gives us a way to write this as:


$$\Delta \ct{\emom[1]}=\AAngle{\int \dPsb{\tw}\Exp[\Big]{-\im\tw^\mu b_\mu}\pa[\Big]{\vIntb[\ct{\emom[1]}]+\rIntb[\ct{\emom[1]}]}}  .$$


We then have: 

$$
\begin{aligned}
\vIntb[\ct{\emom[1]}]&=\hbar^2\im\,  \tm\, \amp{\emom[1],\emom[2] }{ \emom[1]+\hbar \tw,\emom[2]-\hbar \tw}\\
\rIntb[\ct{\emom[1]}]&=\hbar^2\sumint\ddP[2+\abs{X}]{r_1,r_2,r_X}(r_1^\mu-\emom[1]^\mu)\,\ndeltafn[(4)]{\emom[1]+\emom[2]-r_{1}-r_{2}-r_{X}} \\
&\times   \amp{\emom[1], \emom[2] }{ r_{1}, r_{2}, r_{X}} \aamp{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{ r_{1}, r_{2}, r_{X}}.
\end{aligned}
$$


We can extract $\hbar$ from $\tm$ and from the amplitude. In order to determine the $\hbar$ scalin of $\ampl$ we extract each coupling constant $\kappa$ along with an $\frac{1}{\sqrt{\hbar}}$, so that quartic vertices yield a factor of $\frac{\coupling^2}{\hbar}$ whereas cubic ones yield $\frac{\kappa}{\sqrt{\hbar}}$^[as mentioned in the last section, this is true for gravity and (?:sqed) and we will extend this fact to schematically rescale the vertex coupling by $\hbar^-\Half[d-2]$, for $d$ the degree of the vertex in question.].  If we count the number $V_3$ of all cubic vertices, $V_4$ the number of quartic vertices, and so on,  we have that the number of internal lines is $I=\frac{1}{2}(\sum_{d=3}dV_d-E)$. This is because we have $\sum_{d=3}dV_d$  lines to start with, out of which $E$ are chosen to be external. The remaining $(\sum_{d=3}dV_d-E)$ ones are contracted in pairs among themselves to form $I$ internal lines, yielding the factor of $\half$. In our case we have $E=4+M$ where $M=\abs{X}$ is the number of messenger particles. Using the argument from loop counting we have that the number of loops of our graph $L$ is given by:
$$
\begin{aligned}
        L=I-V+N=&\frac{1}{2}(\sum_{d=3}d\cdot V_d-4-M)-\sum_{d=3}V_d+1\\
=&\frac{1}{2}(\sum_{d=3}(d-2)V_d)-1-\frac{M}{2},
\end{aligned}
$$

where $N$ is the number of connected components ($=1$ in our case) . Thus we see that the amount of extracted $\hbar$s corresponds directly to the number of loops plus one plus the number of additonal messenger particles. ^[The number of extracted couplings being twice that.] We can thus write the amplitude $\ampl$ as a sum over reduced $L$-loop amplitudes $\redampl[(L)]$:

$$\amp{\emom[1],\emom[2]}{ r_1,r_2,X}=\sum\limits_{L=0}^\infty\pa[\Big]{\frac{\coupling^{2}}{\hbar}}^{(L+1+\frac{\abs{X}}{2})}\redamp[(L)]{\emom[1],\emom[2]}{r_1,r_2,X}.$$


Going back to the integrands we have:

$$
\begin{aligned}
\vIntb[\ct{\emom[1]}]&=\hbar^3\im\,  \tw\, \sum\limits_{L=0}^\infty\pa[\Big]{\frac{\coupling^{2}}{\hbar}}^{(L+1)}\redamp[(L)]{\emom[1],\emom[2]}{\emom[1]+\hbar \tw,\emom[2]-\hbar\tw}\\
&=\im\, \hbar  \tw\, \sum\limits_{L=0}^\infty \coupling^{2(L+1)}{\hbar}^{(1-L)}\redamp[(L)]{\emom[1],\emom[2]}{\emom[1]+\hbar \tw,\emom[2]-\hbar\tw},
\end{aligned}
$$ {#eq-impulseIv}

as well as the real kernel:[^measurech]

$$
\begin{aligned}
\rIntb[\ct{\emom[1]}]&=\hbar^2\sumint\ddP[\abs {X}]{r_X}\brc[\Big]{\prod\limits_{i=1,2}\dn[4]{w_i}\ndeltafn{2\emom[i] \cdot w_i+w_i^2}\thetafn{\emom[i]^0+w_i^0}} \\
&\times w_1^\mu\,\ndeltafn[(4)]{w_1+w_2+r_{X}}
\\
&\times\amp{\emom[1], \emom[2] }{ \emom[1]+w_{1}, \emom[2]+w_{2}, r_{X}} 
\aamp{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{ \emom[1]+w_{1}, \emom[2]+w_{2}, r_{X}}\\
\end{aligned}
$$

$$
\begin{aligned}
=\hbar^2\sumint&\ddP[\abs {X}]{{r}_X}\brc[\Big]{\prod\limits_{i=1,2}\hbar^3\dn[4]{\bar{w}_i}\ndeltafn{2\emom[i] \cdot \bar{w}_i+\hbar\bar{w}_i^2}\thetafn{\emom[i]^0+\hbar \bar{w}_i^0}} \\
&\times   \hbar \bar{w}_1^\mu\,\hbar^{-4}\ndeltafn[(4)]{\bar{w}_1+\bar{w}_2+\bar{r}_{X}}
\\
&\times\sum\limits_{L=0}^\infty\pa[\Big]{\frac{\coupling^{2}}{\hbar}}^{(2L+2+\abs{X})}\redamp[(L)]{\emom[1], \emom[2] }{\emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}} \\
&\times\aredamp[(L)]{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{\emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}}
\end{aligned}
$$

$$
\begin{aligned}
=\sumint&\ddP[\abs {X}]{{r}_X}\brc[\Big]{\prod\limits_{i=1,2}\dn[4]{\bar{w}_i}\ndeltafn{2\emom[i] \cdot \bar{w}_i+\hbar\bar{w}_i^2}\thetafn{\emom[i]^0+\hbar \bar{w}_i^0}} \\
&\times    \hbar\bar{w}_1^\mu\,\ndeltafn[(4)]{\bar{w}_1+\bar{w}_2+\bar{r}_{X}}
\\
&\times\sum\limits_{L=0}^\infty \coupling^{2(2L+2+\abs{X})}{\hbar}^{2-2L-\abs{X}}\redamp[(L)]{\emom[1], \emom[2] }{\emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}} \\
&\times\aredamp[(L)]{\emom[1]+\hbar \tw,\emom[2]-\hbar \tw }{\emom[1]+\hbar\bar{w}_{1}, \emom[2]+\hbar\bar{w}_2, r_{X}}.\\
\end{aligned}
$$ {#eq-impulseIr}

Schematically we have 

$$
\begin{aligned}
\vIntb[\ct{\emom[1]}]&=\sum\limits_{L=0}^\infty \order[{2(L+1)}]{\coupling},\\
\rIntb[\ct{\emom[1]}]&=\sum\limits_{L=0}^\infty \order[{4(L+1)+2\abs{X}}]{\coupling}
\end{aligned}
$$

The contributions from the virtual kernel are lower order in the coupling $\coupling$ for a given loop order. Both kernels contribute together provided that the following equation is verified:

$$L-1=2L'+\abs{X}.$$ {#eq-rvloopmatch}

where $L$ is the loop count for the virtual kernel and $L'$, $\abs{X}$ are the real kernel loop count and messenger particle count respectively. Note that for a tree level virtual kernel, the real-kernel match does not exist. The real kernel is only present for $L>0$. When taking the classical limit we will only retain contributions from graphs that cancel the $\hbar$ divergences in each corresponding kernel. Thus at the $L$-loop level, the amplitude in the virtual kernel must cancel with terms of order

$$
\hbar^{1-L+O},
$$ {#eq-hbarvirt}

where the $O$ term is the order of $\hbar$ that is present as a result of the observable. In the case of particle 1's momentum, $O=1$. Similarly, the amplitudes in the real kernel must cancel with:

$$
\hbar^{2-2L'-\abs{X}+O}.
$$ {#eq-hbarreal}

Now we see that the (?:lo) contribution [^expand]to the impulse, which we denote $\Delta \emom[1]^{\mu,(0)}$  can only be from the virtual kernel at tree level. Thus, we have the following equation,

$$
\Delta \emom[1]^{\mu,(0)}=\AAngle{\int \dPsb{\tw}\Exp[\big]{-\im\tw^\mu b_\mu}\ \vIntb[\ct{\emom[1]}]^{(L=0)}}.
$$ {#eq-impulseLO}

And the integrand is given by the tree level 4 point amplitude.

$$
\vIntb[\ct{\emom[1]}]^{L=0}=\im\,  \tw^\mu\,  \coupling^{2}{\hbar}^{2}\bar{\mathcal{A}}^{(0)}(\emom[1],\emom[2]\to \emom[1]+\hbar \tw,\emom[2]-\hbar\tw).
$$

At (?:nlo), i.e. $\kappa^4$ order, both integrands contribute, as @eq-rvloopmatch can be satisfied for $L=1$, $L'=0$ and $\abs{X}=2$. Thus we have the following equation:

$$
\Delta \emom[1]^{\mu,(1)}=\AAngle{\int \dPsb{\tw}\Exp[\big]{-\im\tw^\mu b_\mu} \pa[\Big]{\vIntb[\ct{\emom[1]}]^{(L=1)}+\rIntb[\ct{\emom[1]}]^{(L'=0)}}}.
$$ {#eq-impulseNLO}

The virtual integrand is now given by the 1-loop level amplitude, and the real integrand is given by the square of a the tree level amplitude. This process can go on indefinetely, and is independent of the type of observable and the theory. Here we considered the change of momentum a particle, which for a black hole very far away would be very difficult to measure. However, we can also consider an observable such as the four-momentum of the radiated particles, or more precisely its expection value. Of course, the operator corresponding to this observable gives zero when acting on the initial momentum states, and only gives a non-zero result when acting on the messenger states. Thus, for this observable only the real integrand, starting with $\abs{X}=1$ will contribute, the (?:lo) contribution being given by what is essentially the unitarity cut of a two loop amplitude. We see that regardless of observable, the objects that are needed are the amplitudes. 

For each loop level, many diagrams can contribute, but the classical limit enforces that they must cancel the $\hbar$ orders given by @eq-hbarreal and @eq-hbarvirt. The cancellation order is dependent on the considered observable and filters the contributing diagrams. It can also be reformulated in the language of the method of regions. 

To see the whole machinery in action, let us take (?:sqed) as an example theory, that shows the relevant subleties of the formalism.


## (?:sqed) amplitudes 

We want to couple a set of massive scalar fields to electromagnetism. We will use the minimal coupling prescription to ensure that the resulting lagrangian exhibits the required gauge symmetry. The minimal coupling prescription works provided that our free mass lagrangian admits a conserved current. Our free mass lagrangian for two complex scalar fields with different masses is: 

$$
\mathcal{L}_m=\sum\limits_{i=1}^2 \partial_\mu \phi_i^\dagger\,\partial^\mu \phi_i - m_i^2 \phi^\dagger_i \phi_i.
$$

Notice that under the following transformation:

$$
\begin{aligned}
\phi_i(x) &\rightarrow \exp{-\im \charge[i] \lambda} \phi_i(x), \\
\phi_i^{\dagger}(x) &\rightarrow \exp{\im \charge[i] \lambda} \phi_i^\dagger(x) ,\\
\end{aligned}
$$

or infinitesimally:

$$
\begin{aligned}
\delta\phi_i &= -\im  \phi_i \charge[i] \delta\lambda ,\\
\delta\phi_i^{\dagger} &= \im  \phi_i^\dagger \charge[i]\delta \lambda,\\
\end{aligned}
$$

the above Lagrangian is unchanged. We will identitfy $\charge[i]$ with the charge, in units of $\elch$, of each particle. If we upgrade the parameter $\lambda$ to a spacetime function $\lambda(x)$, the Lagrangian is not invariant anymore and invariance is restored if we replace all the derivatives $\partial_\mu$ with the gauge-covariant derivatives $D_\mu$:

$$D_\mu=\partial_\mu+\im \,\elch\,\charge[i]\,A_\mu,$$


 i.e. if along with the transformation above, we perform a gauge transformation of the photon field:

$$A_\mu\rightarrow A_\mu + \frac{1}{\elch} \partial_\mu \lambda$$

or infinitesimally

$$\delta A_\mu = \frac{1}{\elch} \partial_\mu \delta \lambda,$$

then the whole lagrangian: 

$$\mathcal{L}_{ED}+\mathcal{L}_{m}(\phi_i,\partial_\mu \phi_i)\rightarrow \mathcal{L}_{ED}+\mathcal{L}_{m}(\phi_i,D_\mu \phi_i),$$

is invariant under the above defined gauge transformation. The final lagrangian is:


$$\mathcal{L}=-\frac{1}{4} F_{\mu \nu} F^{\mu \nu}+\sum_{i=1}^{2}\left[\left(D_{\mu} \phi_{i}\right)^{\dagger}\left(D^{\mu} \phi_{i}\right)-m_{i}^{2} \phi_{i}^{\dagger} \phi_{i}\right],$$

with $F_{\mu \nu} \equiv \partial_{\mu} A_{\nu}-\partial_{\nu} A_{\mu}$. Expanding and then integrating by parts:

$$
\begin{aligned}
\mathcal{L} &=-\frac{1}{4}\left(\partial_{\mu} A_{\nu}-\partial_{\nu} A_{\mu}\right)\left(\partial^{\mu} A^{\nu}-\partial^{\nu} A^{\mu}\right)
+\sum_{i=1}^{2}\left[
    \left(\partial_{\mu}-\im\, \elch\,\charge[i]\, A_{\mu} \right)\phi_{i}^{\dagger}
    \left(\partial_{\mu}+\im\, \elch\,\charge[i]\, A_{\mu}\right)\phi_{i}
    -m_{i}^{2} \phi_{i}^{\dagger} \phi_{i}
    \right]
 \\
&=\underbrace{
    \frac{1}{2} A_{\mu}\left[\eta^{\mu \nu}\partial^{2}-\partial^{\mu} \partial^{\nu}\right] A_{\nu}
    +\sum\limits_{i=1}^2-\phi_i^{\dagger}\left(\partial^{2}+m_i^{2}\right) \phi_i
    }_{\mathcal{L}_{0}}
+\underbrace{
    \sum\limits_{i=1}^2q_i^2\,\elch^{2} A_{\mu} A^{\mu} \,\phi^{\dagger}_i \phi_i
    -\im\, \elch\,\charge[i]\, A_{\mu}\left(\phi^{\dagger}_i \partial^{\mu} \phi_i-\left(\partial^{\mu} \phi^{\dagger}_i\right) \phi_i\right)
    }_{\mathcal{L}^{\prime}}.
\end{aligned}
$$

Since we have a massless photon, and still have gauge freedom we have to implement gauge fixing in the usual way:

$$
\begin{aligned}\mathcal{L}_{\text{eff}}
      &=\mathcal{L}+\overbracket{\frac{-1}{2 \xi}(\partial_\mu A^\mu)^2}^{\mathcal{L_\text{GF}}}\\
      &=
    \frac{1}{2} A_{\mu}\underbracket{\brc[\Bigg]{g^{\mu \nu}\partial^{2}-\pa[\Big]{1-\frac{1}{\xi}}\partial^{\mu} \partial^{\nu}}}_{\rightarrow \phprop_\xi(k)=\frac{-\im}{k^{2}+\im \varepsilon}\left[g_{\mu \nu}-(1-\xi) \frac{k_{\mu} k_{\nu}}{k^{2}}\right]} A_{\nu}
    +\sum\limits_{i=1}^2-\phi_i^{\dagger}\underbracket{\pa{\partial^{2}+m_i^{2}}}_{\feynprop(q^2)=\frac{\im}{p^{2}-m^{2}+\im \varepsilon}} \phi_i\\
&+
    \sum\limits_{i=1}^2\underbracket{\charge[i]^2\,\elch^{2}\,\eta^{\mu \nu}}_{\times 2\im\rightarrow \mathrm{4-vertex} } A_{\mu} A_{\nu} \,\phi^{\dagger}_i \phi_i
    \underbracket{-\im\, \elch\,\charge[i]\, A_{\mu}\left(\phi^{\dagger}_i \partial^{\mu} \phi_i-\left(\partial^{\mu} \phi^{\dagger}_i\right) \phi_i\right)}_{\times \im\rightarrow \mathrm{3-vertex}}.
\end{aligned}
$$

In the last lines we identify the terms contributing to the Feynman rules. They are given in @tbl-sqedfrules

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
     \graph[ empty nodes,spring layout,node distance=20mm,horizontal=p1 to p4 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1[as=$\mu$] --[photon,thick,postaction={draw,->, 
     shorten >=5mm, shorten <=5mm, 
     decoration={sl,raise=3mm},decorate},"$\ell$" {auto=left ,inner sep=4mm}]  p4[as=$\nu$];
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/photonprop"; limit_to=:picture), tp)
save(PDF("./tikz/photonprop"), tp)
save(SVG("./tikz/photonprop"), tp)
tp
```

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
     \graph[ empty nodes,spring layout,node distance=12mm,horizontal=p1 to p4 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1[as=$\mu$] --[photon,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$k$" {auto=left ,inner sep=4mm}]  p4[fill = red!20, draw = black, ultra thick, circle,scale=.6];
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/extphoton"; limit_to=:picture), tp)
save(SVG("./tikz/extphoton"), tp)
save(PDF("./tikz/extphoton"), tp)
tp
```



```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
     \graph[ empty nodes,spring layout,node distance=20mm,horizontal=p1 to p4 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1 --[thick,->-=.55,postaction={draw,->, 
     shorten >=5mm, shorten <=5mm, 
     decoration={sl,raise=3mm},decorate},"$k$" above=3mm]  p4;
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes,arrows.meta}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/scalarprop"; limit_to=:picture), tp)
save(SVG("./tikz/scalarprop"), tp)
save(PDF("./tikz/scalarprop"), tp)
tp
```

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
     \graph[ empty nodes,spring layout,node distance=12mm,horizontal=p1 to p4 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1 --[thick,->-=.55,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$k$" above=3mm]  p4[fill = red!20, draw = black, ultra thick, circle,scale=.6];
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes,arrows.meta}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/extscalar"; limit_to=:picture), tp)
save(SVG("./tikz/extscalar"), tp)
save(PDF("./tikz/extscalar"), tp)
tp
```

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
     \graph[ empty nodes,spring layout,node distance=15mm,horizontal=p1 to p3 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1 --[thick,->-=.55]  p4[fill = red!20, draw = black, ultra thick, circle,scale=.6] --[thick,->-=.55] p3;
     q1[as=$\mu$] --[thick,photon]  p4 --[thick,photon] q3[as=$\nu$];
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes,arrows.meta}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/seagull"; limit_to=:picture), tp)
save(SVG("./tikz/seagull"), tp)
save(PDF("./tikz/seagull"), tp)
tp
```

```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L""" 
     \graph[ empty nodes,spring layout,node distance=15mm,horizontal=q3 to p4 ,random seed=4,anchor node=a,anchor at={(0,0.5)}] 
{
  p1 --[thick,->-=.55,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$k_i$" {auto=left ,inner sep=3mm}]  p4[fill = red!20, draw = black, ultra thick, circle,scale=.6] --[thick,->-=.55,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$k_i'$" {auto=left ,inner sep=3mm}] p3;
    q3[as=$\nu$] --[thick,photon,] p4;
};

"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes,arrows.meta}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/cubic"; limit_to=:picture), tp)
save(SVG("./tikz/cubic"), tp)
save(PDF("./tikz/cubic"), tp)
tp
```

:::{.fullwidth}

+--------------------------------------------+------------------------+------------------------------------------------+
| For every                                  |                        | Write                                          |
+:===========================================+:=======================+:===============================================+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/photonprop.svg)                 |internal photon line    | $\phprop_\xi( \ell)=\frac{-\im}{ \ell^{2}+     |
| :::                                        |                        | \im \varepsilon}\left[\eta_{\mu \nu}-(1-\xi)   |
| ::: {.content-hidden unless-format="pdf"}  |                        | \frac{\ell_{\mu} \ell_{\nu}}{ ell^{2}}\right]$ |
| ![](./tikz/photonprop.pdf)                 |                        |                                                |
| :::                                        |                        |                                                |
+--------------------------------------------+------------------------+------------------------------------------------+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/scalarprop.svg)                 |internal scalar         | $\feynprop(k^2)=\frac{\im}{k^{2}-m^{2}         |
| :::                                        |                        | +\im \varepsilon}$                             |
| ::: {.content-hidden unless-format="pdf"}  |                        |                                                |
| ![](./tikz/scalarprop.pdf)                 |                        |                                                |
| :::                                        |                        |                                                |
+--------------------------------------------+------------------------+------------------------------------------------+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/seagull.svg)                    | $\phi_i \phi_i^\dagger | $2 \im \charge[i]^2\,\elch^2\,\eta^{\mu \nu}$  |
| :::                                        |  A_\mu A_\nu$  vertex  |                                                |
| ::: {.content-hidden unless-format="pdf"}  |                        |                                                |
| ![](./tikz/seagull.pdf)                    |                        |                                                |
| :::                                        |                        |                                                |
+--------------------------------------------+------------------------+------------------------------------------------+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/cubic.svg)                      | $\phi_i(k_i)           | $\im \elch\,\charge[i]\,(k_i^\mu-              |
| :::                                        | \phi_i^\dagger(k'_i)   |           k_i^{\prime\mu})$                    |
| ::: {.content-hidden unless-format="pdf"}  |  A_\mu$ vertex         |                                                |
| ![](./tikz/cubic.pdf)                      |                        |                                                |
| :::                                        |                        |                                                |
+--------------------------------------------+------------------------+------------------------------------------------+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/extscalar.svg)                  | External scalar        | $\times 1$                                     |
| :::                                        |                        |                                                |
| ::: {.content-hidden unless-format="pdf"}  |                        |                                                |
| ![](./tikz/extscalar.pdf)                  |                        |                                                |
| :::                                        |                        |                                                |
+--------------------------------------------+------------------------+------------------------------------------------+
| ::: {.content-hidden unless-format="html"} |                        |                                                |
| ![](./tikz/extphoton.svg)                  |$\left\{\begin{array}{c}|$\times \left\{\begin{array}{c}\varepsilon_{\mu}|
| :::                                        |  \text { incoming } \\ |   \\ \varepsilon_{\mu}^{* \prime}              |
| ::: {.content-hidden unless-format="pdf"}  |  \text { outgoing }    |     \end{array}\right\}$, with                 |
| ![](./tikz/extphoton.pdf)                  | \end{array}\right\}$   |  $\varepsilon \cdot k=0,                       |
| :::                                        |       photon           |      \varepsilon^{\prime} \cdot k^{\prime}=0$  |
+--------------------------------------------+------------------------+------------------------------------------------+

: Feynman rules for (?:sqed) {#tbl-sqedfrules tbl-colwidths="[25,25,50]"}
:::

where we consider only incoming momenta and the arrows denote incoming or outgoing particles. For the photon, we will take the Feynamn gauge, setting $\xi=1$ and thus $\phprop_1(\ell)=\phprop(\ell)=\frac{-\im \eta^{\mu \nu}}{\ell^{2}+\im \varepsilon}$. 

### Expansions and simplifications

Notice that if we rescale all photon momenta (taking them to be the loop momenta) by $\hbar$ or equivalently take them to be in the soft region: $\abs{k}\sim\abs{q}\ll \abs{p}$, where $p$ is the external momenta, then the photon propagator scales homgeneously in $\hbar$, typically:

$$
\inv{(\ell-\tm)^2}=\inv{\hbar^2}\inv{(\bar{\ell}-\tw)^2},
$$ {#eq-photonscale}

thus contributes $\order[-2]{\hbar}$ to the overall diagram. The matter propagator on the other hand, has inhomgeneous $\hbar$ scaling, as we do not rescale the external momenta, (or equivalently the external momenta are not restricted by the regions). Note that we will not consider internal mass loops as the soft limit means that massive pair production is forbidden, thus massive propagators necessarily route an external momentum. We can nonetheless expand a generic massive propagator in the soft limit:

$$
\begin{aligned}
\inv{(\ell-\emom[i])^2-\mass[i]^2}&=\inv{\ell^2-2\ell\cdot\emom[i] +\cancel{\emom[i]^2}-\cancel{\mass[i]^2}}= \inv{\hbar^2\bar{\ell}^2-2\hbar \bar{\ell}\cdot \emom[i]}\\
&=-\inv{\hbar} \inv{2\bar{\ell}\cdot\emom[i]}\pa{1+\hbar\frac{ \bar{\ell}^2}{2\bar{\ell}\cdot\emom[i]}+\hbar^2\frac{ \bar{\ell}^4}{(2\bar{\ell}\cdot\emom[i])^2}+\dots}.\\
\end{aligned}
$$ {#eq-massiveScale}

In other contexts one may say that the matter propagator has eikonalized (it is now linear in $\ell$). Before we compute the amplitudes let us set up some useful kinematic identities and variables. If we consider the two-to-two particle scattering, taking an all outgoing momentum convention we have the following masses:

$$
 \mass[1]^2=\emom[4]^2 =\emom[1]^2,\quad \mass[2]^2=\emom[2]^2 =\emom[3]^2,
$$ {#eq-masses}

and Mandelstahm variables:

$$
 \mands=(\emom[1]+\emom[2])^2,\quad \mandt=\tm^2=(\emom[1]+\emom[4])^2,\quad \mandu=(\emom[1]+\emom[3])^2   ,
$$

subject to the usual equation:

$$
\mands+\mandt+\mandu=2(\mass[1]^2+\mass[2]^2).
$$

We can also change the external momentum variables to ones more amenable to the soft limit, namely:


$$
\emom[1]=-\pa[\big]{\semom[1]-\Half[\tm]}, \emom[2]=-\pa[\big]{\semom[2]+\Half[\tm]}, \emom[3]=\pa[\big]{\semom[2]-\Half[\tm]}, \emom[4]=\pa[\big]{\semom[1]+\Half[\tm]} .
$$ {#eq-newmom}

The new momentum variables $\semom[i]$ are crucially orthogonal to momentum transfer $\tm$ :^[we use @eq-masses ]

$$
\semom[i]\cdot\tm=0,
$$ {#eq-orthog}


 and the physical scattering region, given by $\mands>(\mass[1]+\mass[2])^2$ and $\tm^2<0$ is the given by the same formulas:

$$
\mands=\pa[\Big]{-\pa[\big]{\semom[1]-\Half[\tm]}-\pa[\big]{\semom[2]+\Half[\tm]}}^2=(\semom[1]+\semom[2])^2
$$

and 

$$
\mandt=\pa[\Big]{-\pa[\big]{\semom[1]-\Half[\tm]}+\semom[1]+\Half[\tm]}^2 = \tm^2.
$$

With all the ingredients in place, we can now go on to compute the amplitudes. 

### Tree level

We start with the tree level amplitude, the only (?:lo) contribution in for example @eq-impulseLO. The only possible diagram we can build with four external scalar legs, and vertices as defined in @tbl-sqedfrules, is the following tree:


```{julia}
#| echo: false
#| output: false
#| eval: false
using TikzPictures

tp = TikzPicture(L"""
\matrix{
      \node{$\displaystyle \im\redamp[(0)]{\semom[1]-\Half[\tm],\semom[2]+\Half[\tm]}{\semom[1]+\Half[\tm],\semom[2]-\Half[\tm]}$};&
      \node{$=$};&
     \graph[nodes=coordinate, empty nodes,spring layout,node distance=20mm,vertical=p1 to p2,random seed=1,anchor node=a,anchor at={(0,0.5)}] 
{
  p1 --[->-=.5,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm,mirror},decorate},"$\semom[1]-\Half[\tm]$" {auto=right ,inner sep=4mm}]  a[fill = red!20, draw = black, ultra thick, circle,scale=.6] --[->-=.7,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm,mirror},decorate},"$\semom[1]+\Half[\tm]$" {auto=right ,inner sep=4mm}] p4;
  a -- [photon,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$q$" {auto=left ,inner sep=4mm}]] b[fill = red!20, draw = black, ultra thick, circle,scale=.6];
  p2 --[->-=.5,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$\semom[2]+\Half[\tm]$" {auto=left ,inner sep=4mm}]]  b --[->-=.7,thick,postaction={draw,->, 
     shorten >=3mm, shorten <=3mm, 
     decoration={sl,raise=3mm},decorate},"$ \semom[2]-\Half[\tm]$" {auto=left ,inner sep=4mm}]] p3;
};\\
};"""
,preamble="\\usepackage{adjustbox}\\usepackage{amsmath}\\usetikzlibrary{decorations.markings,graphs,decorations.pathmorphing,graphdrawing,quotes,arrows.meta}\\usegdlibrary{trees,force}\\input{../latexmacros.tex}")

save(TEX("./tikz/treelevelsqed"; limit_to=:picture), tp)
save(PDF("./tikz/treelevelsqed"), tp)
save(SVG("./tikz/treelevelsqed"), tp)
tp
```


![Tree](./tikz/treelevelsqed)



The amplitude is read off diagram and using Feynman rules for SQED we have: 

$$
\redampl[(0)] = \im\phprop(q)\cdot \,\elch^2\charge[1] \charge[2]2 \ct{\semom[1]} 2\ct[\nu]{\semom[2]}=\frac{4\elch^2\charge[1] \charge[2]\semom[1]\cdot\semom[2]}{\tm^2} ,
$$

using the Mandelstahm invariants described above we can write this as:

$$
\redampl[(0)] =\elch^2\charge[1] \charge[2] \frac{4\mass[1]\mass[2]\relfact}{\hbar^2\tw^2},
$$ {#eq-treeampl}


where $\relfact$ is the relativistic factor of particle 1 in the rest frame of particle 2:

$$
\relfact=\frac{\mands-\mass[1]^2-\mass[2]^2}{2\mass[1]\mass[2]}=\frac{\emom[1]\cdot\emom[2]}{\mass[1]\mass[2]}=\frac{\semom[1]\cdot\semom[2]}{\mass[1]\mass[2]}+ \order{\hbar}.
$$ {#eq-relfact}

We now input the reduced version $\redampl[(0)]\elch^2=\ampl[(0)]$ of the amplitude, and take the $\hbar\to0$ limit of @eq-impulseLO. We can safely take the $\hbar \to 0$ limit as the integrand contains no terms singular in $\hbar$ (the $\frac{1}{\hbar^2}$ is cancelled by the $\hbar^2$ pre-factor).  Notice that the integration measure @eq-DeltaOclas simplifies in the classical limit:[^comp]

$$
\lim\limits_{\hbar \to0} \dPsb{\tw}=\dn[4]{\tw} {\ndeltafn{2\mass[1]\cls{\vel[1]}\cdot\tw}}{\ndeltafn{2\mass[2]\cls{\vel[2]}\cdot \tw }}.
$$

The integrand corresponding to the (?:lo) contribution to the impulse is then:

$$
\Delta \emom[1]^{\mu,(0)}=4e^2Q_1Q_2\mass[1]\mass[2]\relfact\int\dn[4]{\tw}\exp{-\im\tw\cdot b}\tw^\mu \frac{\cancel{\hbar^2}}{\cancel{\hbar^2}\tw^2}{\ndeltafn{2\mass[1]\cls{\vel[1]}\cdot\tw}}{\ndeltafn{2\mass[2]\cls{\vel[2]}\cdot \tw }}.
$$

This can be analytically computed to find a closed form for the (?:lo) impulse.

$$
\Delta \emom[1]^{\mu,(0)}=-\frac{e^{2} Q_{1} Q_{2}}{2 \pi} \frac{\gamma}{\sqrt{\gamma^{2}-1}} \frac{b^{\mu}}{b^{2}}
$$


### One loop

Already at one loop the number of possible diagrams increases dramatically from 1 to 13. One can nonetheless enumerate them. As we increase loop count, the number of diagrams increases exponentially. It is therefore useful to have a systematic, programmatic way to handle these diagrams, and while we are at it, also to compute the amplitudes. Note that all the code needed to do these computations can be found on the repository for this book: <https://github.com/lcnhb/GWAmplitudes>. 

The first tool we will use is `QGRAF` @Nogueira:1993a, a Fortran based program that can generate Feynman diagrams for a given set of vertices and external legs. The first step is to define the theory we want to derive the diagrams from. This is essentially writing down the Feynman rules, without actually specifying what the graphical objects are. For (?:sqed) the model file is short:


```{.default filename="SQEDmodel"}
* propagators
 [Phi1,Phi1c,+]
 [Phi2,Phi2c,+]
 [Photon,Photon,+]

* vertices
 [Phi1c,Photon,Phi1]
 [Phi2c,Photon,Phi2]
 [Phi1c,Photon,Photon,Phi1]
 [Phi2c,Photon,Photon,Phi2]
```

This file also defines the names of the fields in question. We can then give `QGRAF` additional options, such as the number of external legs, and the number of loops, written in a `qgraf.dat` file that can look like this:

```{.default filename="qgraf.dat"}
output= '{{output filename}}' ;
style= './styles/julia.sty' ; 

model= './qgraf/SQEDmodel';

in= Phi1,  Phi2;
out= Phi1,Phi2;
loops= 1;
loop_momentum= k;

options=  notadpole,nosnail,onshell ;
```

where we specify what process we are interested in (two-to-two scattering). We also specify that we want to compute the one loop amplitude, and that we want to use the `julia.sty` style file. The `julia.sty` file is a style file that is used to generate the output in a format that can be read by a `Julia` [@Bezanson:2015]  package built to process and visualise the outputted graphs. This package is called (maybe too broadly) `QFT.jl`, and is hosted on [github](https://github.com/lcnhb/QFT.jl) . Let us see it in action. We can run `QGRAF` from the command line, and it will generate a file called `{{output filename}}` that contains the output of the program. We can then use this in a `Julia`  file to visualise the diagrams.

```{julia}
#| output: asis
using Images
using QFT
using QFT.Diagrams
using QFT.FieldGraphs
using QFT.Fields
import  Catlab.Graphics.Graphviz: pprint
include("SQED.jl")
diags=include("QGRAFout/julia/1lSQED.jl")


qDiags=[qDiagram(;diag...) for diag in diags]
grafs=(x -> x.g).(qDiags)
println("::: {#fig-oneloopsqed  layout-ncol=4 .column-body-right }")
for (i,graf) in enumerate(grafs)
println("```{dot}")
println("//| fig-width: 1.5")
    pprint(stdout,to_graphviz(graf,graph_attrs=Dict("layout"=>"neato")))
    println("```")
end
println("all one loop graphs in (?:sqed)")
println(":::")
nothing
```



We notice a few things about the diagrams in @fig-oneloopsqed above. Not all the diagrams contribute to the classical limit. Clearly the diagrams with internal matter loops cannot be allowed when the momenta incoming to the loop is soft ^[scales like $\hbar$]. In the classical limit this momenta will go to 0, and since the scalars are massive, they need momentum greater than their mass to be pair produced, thus these diagrams do not contribute. Another class of diagrams that does not contribute to the classical limit are the ones with photon loops that start and end on the same matter line. These do not contribute because they are scaleless. An integral is scaleless when its integrand $\mathcal{I}_\text{scaleless}(\brk{\ell_i})$ scales homegenously under any rescaling of the loop momentum $\ell_i$:

$$
\mathcal{I}_\text{scaleless}(\brk{\ell_i})\stackrel{\ell_j\to\lambda \ell_j}{\longrightarrow}\lambda^\eta \mathcal{I}_\text{scaleless}(\brk{\ell_i})
$$

Thus any diagram that has a basis of loops that does not contain both scalar fields (i.e. does not cross over) cannot have its scale set by the momentum transfer, and is thus scaleless. Dimensionally regularised scaleless integrals vanish, thus we can also discard these diagrams. We can easily implement such a filter programatically, by checking that if cycles are present they touch either both types of scalars, or neither. To compute the cycle basis we use an algorithm derived from @Paton:1969, implemented in the [DirectedHalfEdgeGraphs.jl](https://github.com/lcnhb/DirectedHalfEdgeGraphs.jl) package.


```{julia}
#| output: asis
using Logging
Logging.disable_logging(Logging.Info)
function scaleless(g::AbstractFieldGraph)
  cycles =cycle_basis(g)
  isscaleless=false
  for c in cycles
    hs= collect(Iterators.flatten(half_edges.(Ref(g),c)))
    fields=unique!(typeof.(field.(Ref(g),hs)))
    if Bool(Phi1 in fields) ⊻  Bool(Phi2 in fields)
      isscaleless=true
    end
  end
  return isscaleless
end

noscalelessdiags=qDiags[.!scaleless.(grafs)]
classicaldiags=noscalelessdiags[2:end]
for (i,d) in enumerate(classicaldiags)
  d.ID=i
end

println("::: {#fig-onefilterloopsqed  layout-ncol=5 .column-body-right }")
for (i,graf) in enumerate(grafs[.!scaleless.(grafs)])
println("```{dot}")
println("//| fig-width: 1")
    pprint(stdout,to_graphviz(graf,graph_attrs=Dict("layout"=>"neato")))
    println("```")
end
println("one loop graphs that contribute to the classical limit in (?:sqed)")
println(":::")
nothing
```

There is one final simplification we can do. The first diagram in @fig-onefilterloopsqed  has two photon propagators, and two quartic vertices, which give it the name: "double-seagull". The photon propagators have homogeonous $\hbar^{-2}$ scaling (see @eq-photonscale), the vertices only bring constants, and the loop integration has $\hbar^4$ scaling. Collecting all scalings this means that the reduced amplitude has $\hbar^0$ scaling. However in the virtual integrand the reduced amplitude has to cancel with the transfer momentum's $\hbar$ scale (see @eq-impulseIr). Thus the double seagull diagram vanishes in the classical limit.

We are left with only 4 diagrams, the two triangle diagrams, the box and cross box, which we can now compute. At this point, we can do this manually, but again, putting in place a programatic framework means that subsequent loops can be treated systematically^[at least at the unintegrated level]. We will also extract one of these integrands by hand, for completeness and comparison. 

The first step is to define the Feynman rules in a computer readable format. We will use `Julia`  to apply these rules at every vertex and every edge, but for the actual computation we will use `FORM` [@Vermaseren:2000nd;@Kuipers:2012rf], which can automatically contract indices and performs expression manipulations in an optimized way. The Feynman rules implementation in the package developped for this thesis make use of `Julia`s defining paradigm of multiple dispatch. This allows us to define the rules for each vertex and each edge in a very compact way. We can define the rules for (?:sqed) as follows:

```{julia}
#| output: false
#| eval: false
#| code-overflow: wrap
function feynmanRule(mime::MIME"text/FORM",p,f1::Photon,f2::Photon)
  momen = repr(mime,p.symbol)
  indx1 = repr(mime,index(f1))
  indx2 = repr(mime,index(f2))
  "_i* prop(-1,0,$momen)*d_($indx1,$indx2)"
end

@symmetric function feynmanRule(mime::MIME"text/FORM",p,[f1::Phi1,f2::Phi1c])
  momen = repr(mime,p.symbol)
  "_i* prop(-1,1,$momen)"
end

@symmetric function feynmanRule(mime::MIME"text/FORM",p,[f1::Phi2,f2::Phi2c])
  momen = repr(mime,p.symbol)

  "_i* prop(-1,2,$momen)"
end

@symmetric function feynmanRule(mime::MIME"text/FORM",[(pᵩ₁,a)::Tuple{Any,ScalarField{S}},
            (pᵩ₂,b)::Tuple{Any,AdjointField{ScalarField{S}}},
            (pᵧ,γ)::Tuple{Any,Photon}]) where {S}
  p1 = repr(mime,pᵩ₁(index(γ)))
  p2 = repr(mime,pᵩ₂(index(γ)))
  q = repr(mime,charge(a))
  "_i*e*$q*($p2-$p1)"
end

@symmetric function feynmanRule(mime::MIME"text/FORM",[(pᵧ₁,γ₁)::Tuple{Any,Photon},
            (pᵧ₂,γ₂)::Tuple{Any,Photon},(pᵩ₂,b)::Tuple{Any,AdjointField{ScalarField{S}}},
            (pᵩ₁,a)::Tuple{Any,ScalarField{S}}]) where {S}    
  mu = repr(mime,index(γ₁))
  nu = repr(mime,index(γ₂)) 
  q = repr(mime,charge(a))
  "2*_i*$q^2*e^2*d_($mu,$nu)"
end 
```

where we define `prop(n,i,p)` as representing a generic Feynman propagator, which we will denote:

$$
 D_{-}(n,i,p)=\mathtt{prop(n,i,p)}=\pa{p^2-m_i^2+i\epsilon}^{n} \quad \text{thus} \quad \mathtt{prop(-1,i,p)}=\frac{1}{p^2-m_i^2+i\epsilon}.
$$

We can now apply these feynamn rules to the graphs we have left, obtaining `FORM` readable integrands. For example, the box diagram gives:

```{julia}
#| echo: false
#| output: false
#| eval: false


open("diags.frm";create=true,write=true) do io
  write(io,"""
  Symbol x;
Auto V p;
Auto V p;
Auto V q;
Auto S m;
S e;
Auto S Q;
Auto I nu;
CF prop;
CF inv;
  """)
  for qd in classicaldiags
    toform(io,qd)
    println(io,"")
  end
end;
```

```{julia}
#| echo: fenced
toform(stdout,classicaldiags[3])
```

Notice that we also define the momentum routing by imposing the replacement rules, one per vertex. This can be done in many ways but to ensure proper scaling we set the loop momenta to be homogeous on the massless lines. This is done by the `Julia` program, using kruskal's algorithm [@Kruskal:1956] to find the maximal-mass spanning tree of the graph, and then setting the loop momenta to be those internal edges that are missing from the tree. The maximal mass spanning tree of the box is visualized in @fig-kruskalbox .Using `FORM`, we can contract indices and apply the momentum conservation rules. Finally we also apply the relabeling rules described in @eq-newmom. The `FORM` version of the box integrand is then given in @lst-formBox.

```{julia}
#| echo: false
#| output: false
#| eval: false

import  Catlab.Graphics.Graphviz: run_graphviz

open("kruskalbox.png";create=true,write=true) do io
run_graphviz( io,to_graphviz(kruskal(classicaldiags[3].g,mass;rev=true),node_labels=true, edge_labels=true,graph_attrs=Dict("layout"=>"neato")),format="png") 
end
```

![The maximal mass spanning tree of the box diagram in blue. The loop momenta are the edges that are missing from the tree.](kruskalbox.png){#fig-kruskalbox .margin}



```{.default #lst-formBox .sql lst-cap="Box integrand in FORM"}

   [d3l1|o.3.4|i.3.4|i|o|] =
         ( prop(-1,0,q - l1) )
       * ( prop(-1,0,l1) )
       * ( prop(-1,1,1/2*q - l1 + pb1) )
       * ( prop(-1,2, - 1/2*q + l1 + pb2) )
       * ( dot(q,q) - 2*dot(q,l1) - 2*dot(q,pb2) + 2*dot(q,pb1) + dot(l1,l1)
          + 2*dot(l1,pb2) - 2*dot(l1,pb1) - 4*dot(pb2,pb1) )
       * ( dot(l1,l1) + 2*dot(l1,pb2) - 2*dot(l1,pb1) - 4*dot(pb2,pb1) )
       * ( qch2 ) * ( qch2 ) * ( qch1 ) * ( qch1 )
       * ( e ) * ( e ) * ( e ) * ( e );
```

When applied to all 4 diagrams, we obtain precisely the same integrands as those in @Kosower:2018adc. Additionally we notice that the two triangles and the box diagram have overlapping propagators. In fact the denominators of the integrands for all three can be written as:

$$
\Box_{i_1,i_2,i_3,i_4}=\inv{\rho_1^{i_1}\rho_2^{i_2}\rho_3^{i_3}\rho_4^{i_4}},
$$ {#eq-boxfam}

for powers $\brk{i}\in\brk{0,1}^4$, where the inverse propagators $\rho_i$ are:

$$
\rho_1=\ell^2+\im \epsilon,\quad \rho_2=(\ell-q)^2+\im \epsilon,\quad \rho_3=(\Half[q]-\ell+\semom[1])^2-\mass[1]^2+\im \epsilon,\quad \rho_4=(-  \Half[q]+\ell+\semom[2])^2-\mass[2]^2+\im \epsilon
$$

Note that in the classical limit we can expand the massive propagators as shown in @eq-massiveScale and obtain, to first order in $\hbar$,

$$
\rho_3=2\ell\cdot\semom[1]+\im \epsilon,\quad \rho_4= -2\ell\cdot\semom[2]+\im \epsilon,
$$

where we used @eq-orthog. The cross box can in fact extend this family, by adding just one more inverse propagator. We now have the complete description of the denominators of all 1-loop contributing diagrams. The numerators in fact do not complicate things much. They are all composed of scalar products of momenta. If these do not contain loop-momenta they are just constant factors in front of the integral. The scalar products that do contain loop momenta can be written as inverse powers of the propagators. This is the case for any Feynman like integrand. Consider the following general integrand:

$$
\mathcal{I}= \frac{\mathcal{N}}{\mathcal{D}}=\frac{\prod\limits_{S'}N_{S'}}{\prod\limits_{S}D_S}=\frac{\prod\limits_{S'}\sum\limits_{i\geq j} S'_{ij}p_i\cdot p_j}{\prod\limits_{S}\sum\limits_{i\geq j} S_{ij}p_i\cdot p_j},
$$

where ${S}$ and ${S'}$ are sets of coefficient matrices for all possible dot products. If we have a quadruplet $\brk{A,B,a,b}$ such that $A_{a,b}\neq0$ and $B_{a,b}neq0$ and $p_{a}$or $p_{b}$ is a loop momentum $\ell$, say $p_a=\ell$,then it is useful to write this component of the integrand as:

$$
\frac{N_{B}}{D_{A}}=\frac{\tilde{N}_B+B_{ab}\ell\cdot p_b}{A_{ab}\ell\cdot p_b +\sum\limits_{\substack{i\geq j \\ i,j\neq a,b}}A_{ij}p_i\cdot p_j}=\frac{\tilde{N}_B}{D_A}+\frac{B_{ab}}{A_{ab}}\pa[\Big]{1-\frac{\tilde{D}_A}{D_A}},
$$ {#eq-scalarred}

where the tilde means that we have remove the $ab$ contribution. Thus, we see that we obtain a sum of objects in the numerator, none of which contains the dot product: $\ell\cdot p_b$. We can do this for every quadruplet $\brk{A,B,a,b}$, after every replacement, and obtain an integrand containing only so called *irreducible* loop-momenta scalar products. In the cases we have here, they all disappear, leaving us truly with a family of integrands like @eq-boxfam. This can be readily fed into a IBP solver, such as `AIR` [@Anastasiou:2004], `FIRE` [@Smirnov:2020] or `Kira` [@Maierhofer:2018]. 

With such a solver we can obtain a complete family of integrals, which can be evaluated. We are thus able to obtain the integrated integrands at (?:nlo) that are then used in @eq-impulseIr and @eq-impulseIv. The algorithm described above was implemented in `FORM` and is able to rapidly process the 1-loop diagrams. The code is available in the repository for this thesis. 

Importantly, we still need to take the classical limit. At this point a problem shows up. The box and cross box integrals are divergent in the classical limit (some authors call this super classical). Let us see this for the box integral. We have from @lst-formBox that the integral for the box diagram $B$ is: 

$$
\im B = \elch^4 Q_{1} Q_{2} \int \dn[D]{\ell} \\pa{4 \semom[1]\cdot \semom[2]  + 2\ell\cdot\pa{\semom[2] -\semom[1]} -\pa{\tm-\ell}^2}\pa{4 \semom[1]\cdot \semom[2]  + 2\ell\cdot\pa{\semom[2] -\semom[1]} -\pa{\ell}^2}Box_{1,1,1,1}
$$

we can apply the procedure described above, turning messenger momenta into wavenumbers:

$$
\im B = \elch^4 Q_{1} Q_{2} \int \dn[D]{\bar{\ell}}\frac{\hbar^D}{\hbar^6} \pa{4 \semom[1]\cdot \semom[2]  + \hbar2\bar{\ell}\cdot\pa{\semom[2] -\semom[1]} -\hbar^2\pa{\tw-\bar{\ell}}^2}\pa{4 \semom[1]\cdot \semom[2]  + \hbar2\bar{\ell}\cdot\pa{\semom[2] -\semom[1]} -\hbar^2\pa{\bar{\ell}}^2}\Box_{\bar{1},\bar{1},\bar{1},\bar{1}},
$$

where $\Box_{\bar{i}_1,\bar{i}_2,\bar{i}_3,\bar{i}_4} =\inv{\hbar^{2(i_1+i_2)+i_3+i_4}} \Box_{i_1,i_2,i_3,i_4}$ is the box family with wavenumber instead of messenger momenta, and $\hbar$s extracted. We notice that if we apply the scalar product reduction @eq-scalarred, we will necessarily still have an integral of the form^[along with ones that are of the form $\Box_{1,1,1,0}$ and other permutations. These are not divergent in the classical limit, as they have one less propagator, thus one less $\hbar$, just enough to cancel what is left of the $\hbar$ in the numerator, and have an overall $\order[0]{\hbar}$ scaling.]:

$$
\elch^4 Q_{1} Q_{2} 16 (\semom[1]\cdot \semom[2])^2 \int \dn[D]{{\ell}}\Box_{1,1,1,1}=\order[D-6]{\hbar}.
$$

We need to cancel with the $\hbar$ in the classical limit (@eq-hbarvirt), here we have one too many orders in the denominator (if D=4). Thus we would get a divergent ($\inv{\hbar}$) contribution when taking the classical $\hbar\to 0$ limit. If we consider now the cross box, which is the same family as above but with an extra minus sign:

$$
\tilde{\rho}_4=( \Half[q] -\ell+\semom[2])^2-\mass[2]^2+\im \epsilon\simeq  2\ell\cdot\semom[2]+\im \epsilon.
$$

If we write that $\Box_{i_1^+,i_2^+,i_3^+,i_4^+}=\Box_{i_1,i_2,i_3,i_4}$ where the sign is the sign of the $\im\epsilon$ presciption, then we can write the cross box integral as:
$$
\int \dn[D]{\ell} -\Box_{1,1,1,1^-}
$$

thus summing up the two divergent contributions from the box and cross box we have:


$$
\Box_{1,1,1,1}-\Box_{1,1,1,1^-}=\Box_{1,1,1,0}\pa[\Big]{\inv{-2\ell\cdot\semom[2]+\im \epsilon}-\inv{    2\ell\cdot\semom[2]+\im \epsilon}}=-\im\Box_{1,1,1,0}\ndeltafn{2\ell\cdot\semom[2]},
$$ {#eq-boxcross}

where in the equation line we used *reverse unitarity* [@Anastasiou:2002yz;@Anastasiou:2002qz;@Anastasiou:2003yy]. This idea was developed in the context of cross-section calculations in the for collider physics. It enables to set on equal footing real contributions ^[such as ones in the real integrand @eq-rInt] where we integrate over on shell momenta ^[thus three dimensional momentum space] and virtual integrals, where the integration is over all possible four-momentum ^[as virtual particles can be off shell]. The idea is to trade the on-shell delta functions and their $n$-th derivatives for differences of (powers of) propagators with alternating $\im \epsilon$:

$$
\frac{\im}{(-1)^ nn!} \odv[n]{}{z} \ndeltafn{z}   = \inv{\pa{z  -\im \epsilon}^{(n+1)}}  - \inv{\pa{z+\im \epsilon}^{(n+1)}}.
$$ {#eq-reverseunitarity}

In our case @eq-reverseunitarity implies the following identities:

$$
\ndeltafn{-2\ell\cdot\semom[2]}=\im\pa{\Box_{0,0,0,1}-\Box_{0,0,0,1^-}}
$$ {#eq-revone}

$$
\ndeltafn{2\ell\cdot\semom[1]}=\im\pa{\Box_{0,0,1,0}-\Box_{0,0,1^-,0}}
$$ {#eq-revtwo}

Since we where able to write this difference of propagators as a sort of cut, we could further compare the divergent part of the box and cross box with the corresponding real contribution, which is at tree level, with no cut messengers: $L'=0$ and $\abs{X}=0$ such that @eq-rvloopmatch is satisfied. We have:


$$
\begin{aligned}
\int &\dn[4]{\bar{w}}\ndeltafn{2\semom[1]\cdot \bar{w}-\hbar\Half[\tw] \cdot \bar{w}  +\hbar\bar{w}^2}\ndeltafn{-2\semom[2] \cdot \bar{w}+\hbar\Half[\tw] \cdot \bar{w}+\hbar\bar{w}^2} \\
&\times    \hbar\bar{w}^\mu\\
&\times\coupling^{4}{\hbar}^{2}\redamp[(0)]{\semom[1]-\hbar\Half[\tw],\semom[2]+\hbar\Half[\tw] }{\semom[1]+\hbar\Half[\tw]+\hbar\bar{w}, \semom[2]-\hbar\Half[\tw]-\hbar\bar{w}_2} \\
&\times\aredamp[(0)]{\semom[1]+\hbar\Half[\tw],\semom[2]+\hbar\Half[\tw]-\hbar \tw}{\semom[1]-\hbar\Half[\tw]+\hbar\bar{w}, \semom[2]+\hbar\Half[\tw]-   \hbar\bar{w}_2}.
\end{aligned}
$$

where the $\redampl[(0)]$ we already computed in @eq-treeampl, and we have eliminated the theta functions in preparation of taking the classical limit. Thus it is essentially a cut of a one-loop box. Notice that in the classical limit we must cancel with $\hbar^3$ (@eq-hbarreal) which at leading order is again overdone. The $\semom[1]\cdot \semom[2]$ contribution from each tree scales like $\inv{\hbar^4}$, and is thus classically divergent as the box and cross box before it. We also notice it has the following form:

$$
\elch^4 Q_{1} Q_{2} 16 (\semom[1]\cdot \semom[2])^2\inv{\hbar}\int \dn[4]{\bar{\ell}}\bar{\ell}^\mu\ndeltafn{2\semom[1] \cdot \bar{\ell}}\ndeltafn{-2\semom[2] \cdot \bar{\ell}}\Box_{\bar{1},\bar{1},\bar{0},\bar{0}},
$$

where we have changed variables from $\bar{w}$ to $\bar{\ell}$ and removed the $\hbar(\Half[\tw] \cdot \bar{\ell}\pm\bar{ \ell}^2)$ term in the delta functions, in prepation for the classical limit. We can now apply reverse unitarity (@eq-revone,@eq-revtwo) and focus on the integral without the prefactors:

$$
\begin{aligned}
\int \dn[4]{\bar{\ell}}\bar{\ell}^\mu&\ndeltafn{2\semom[1] \cdot \bar{\ell}}\ndeltafn{-2\semom[2] \cdot \bar{\ell}}\Box_{\bar{1},\bar{1},\bar{0},\bar{0}}  =    \int \dn[4]{\bar{\ell}}\bar{\ell}^\mu\ndeltafn{2\semom[1] \cdot \bar{\ell}}\im\pa{\Box_{0,0,0,1}-\Box_{0,0,0,1^-}}\Box_{\bar{1},\bar{1},\bar{0},\bar{0}}  \\  
&=-\int \dn[4]{\bar{\ell}}\bar{\ell}^\mu\pa{\Box_{0,0,1,0}-\Box_{0,0,1^-,0}}\pa{\Box_{1,1,0,1}-\Box_{1,1,0,1^-}} ,\\
&=\int \dn[4]{\bar{\ell}}\bar{\ell}^\mu\brc{\pa{\Box_{1,1,1,1^-}-\Box_{1,1,1,1}}+\pa{\Box_{1,1,1^-,1}-\Box_{1,1,1^-,1^-}}} .
\end{aligned}
$$

We now notice something interesting, this cut integral has a sort of horizontal flip symmetry, i.e. if we average over the existing 'loop' momentum labelling and a new $\ell'=q-\ell$ we eliminate the $\ct{\ell}$ dependence in the numerator:

$$
\Half\brc{\ct{\ell}+\pa{\ct{q}-\ct{\ell}}}=\ct{q}
$$

since the box families transform as:

$$
\Box'_{i,j,m,n}=(-1)^m(-1 )^n\Box_{j,i,-m,-n}.
$$ {#eq-boxtrans}

Thus we have that the cut integral with the $\ct{\tw}$ factored out:

$$
\int \dn[4]{\bar{\ell}}\Half\brc{\pa{\Box_{1,1,1,1^-}-\Box_{1,1,1,1}}+\pa{\Box_{1,1,1^-,1}-\Box_{1,1,1^-,1^-}}} .
$$

We can apply the relabelling only this time only for the last two integrands, and the integral becomes, applying @eq-boxtrans:

$$
\int \dn[4]{\bar{\ell}}\Half\brc{\pa{\Box_{1,1,1,1^-}-\Box_{1,1,1,1}}+\pa{\Box'_{1,1,1^-,1}-\Box'_{1,1,1^-,1^-}}}= \int \dn[4]{\bar{\ell}}\pa{\Box_{1,1,1,1^-}-\Box_{1,1,1,1}}  .
$$

If we now add the box and cross box contributions from @eq-boxcross we get:

$$
\int \dn[4]{\bar{\ell}}\pa{\bcancel{\Box_{1,1,1,1^-}}-\cancel{\Box_{1,1,1,1}}}+\cancel{\Box_{1,1,1,1}}-\bcancel{\Box_{1,1,1,1^-}}  =  0.
$$

The classically divergent terms have cancelled leaving us with only the finite terms. We now have full control over the classical limit of the one loop contrbution to the real and virtual parts of the amplitude. 

### Higher order and gravity 

The code provided is fully general in loop number and can be extended readily to higher loops, at the unintegrated level. The number of contributing diagrams quickly increases however. At two loops, we go from 5 non-scaleless diagrams to 34 (see @fig-2lSQEDclassical), and at three loops we have 470 diagrams (see @fig-3lSQEDclassical). 

```{julia}
#| echo: false
#| output: false
#| eval: false
diags=include("QGRAFout/julia/2lSQED.jl")
qDiags=[qDiagram(;diag...) for diag in diags]
grafs=(x -> x.g).(qDiags)
noscalelessdiags=qDiags[.!scaleless.(grafs)]

import Catlab.Theories: ⊕
function ⊕(a, b...)
  return ⊕(a, ⊕(b...))
end

alldiags=(⊕(((x -> x.g).(noscalelessdiags))...))
open("2lSQEDclass.dot";create=true,write=true) do io
pprint( io,to_graphviz(alldiags,graph_attrs=Dict("layout"=>"neato")))
end
```

```{dot}
//| fig-width: 8
//| label: fig-2lSQEDclassical
//| fig-cap: "All scaleful diagrams, in the classical limit at two loops in SQED"
//| file: 2lSQEDclass.dot
//| cap-location: margin
```

```{julia}
#| echo: false
#| output: false
#| eval: false

import  Catlab.Graphics.Graphviz: run_graphviz
diags=include("QGRAFout/julia/3lSQED.jl")
qDiags=[qDiagram(;diag...) for diag in diags]
grafs=(x -> x.g).(qDiags)
noscalelessdiags=grafs[.!scaleless.(grafs)]


alldiags=(⊕(noscalelessdiags...))
open("3lSQEDclass.png";create=true,write=true) do io

run_graphviz(io, to_graphviz(alldiags,graph_attrs=Dict("layout"=>"neato")), format="png")
end
```

![All scaleful diagrams, in the classical limit at three loops in SQED](3lSQEDclass.png){#fig-3lSQEDclassical}



The classically divergent term cancelations, have been explicitly derived above for the one loop case, however it is not immediately extendable to higher loops. Arguments using Cutkosky rules have been used in [Herrmann et al. @Herrmann:2021tct] to show this at two loops. 

We have up to now only considered the toy model of scalar QED, however the same techniques can be applied to gravity. In this case one considers the same scalars minimally coupled to gravity, using the Einstein-Hilbert action. Going through the same procedures as above, with more algebra, one can also obtain Feynman rules. One key difference is that the gravitons self interact, and do so for any vertex degree. Additionally the graviton-scalar vertex can also involve any number of gravitons. Of course the highest degree vertex is always limited by the number of loops, such that in practice, one only needs to consider truncated Feynman rules. We implemented these rules in `QGRAF` and `Julia` and we can see the resulting diagrams at one loop in @fig-1lGRclassical only contains one new diagram, and two loops @fig-2lGRclassical, there are substantially more new diagrams. 



```{julia}
#| echo: false
#| output: false
#| eval: false
include("GR.jl")
diags=include("QGRAFout/julia/1lGR.jl")
qDiags=[qDiagram(;diag...) for diag in diags]
grafs=(x -> x.g).(qDiags)
noscalelessdiags=grafs[.!scaleless.(grafs)]

import Catlab.Theories: ⊕
function ⊕(a, b...)
  return ⊕(a, ⊕(b...))
end


alldiags=(⊕(noscalelessdiags...))
open("1lGRclass.dot";create=true,write=true) do io
pprint( io,to_graphviz(alldiags,graph_attrs=Dict("layout"=>"neato")))
end
```

```{dot}
//| fig-width: 8
//| label: fig-1lGRclassical
//| fig-cap: "All scaleful diagrams, in the classical limit at 1 loop in GR"
//| file: 1lGRclass.dot
//| cap-location: margin
```


```{julia}
#| echo: false
#| output: false
#| eval: false
diags=include("QGRAFout/julia/2lGR.jl")
qDiags=[qDiagram(;diag...) for diag in diags]
grafs=(x -> x.g).(qDiags)
noscalelessdiags=grafs[.!scaleless.(grafs)]

import Catlab.Theories: ⊕
function ⊕(a, b...)
  return ⊕(a, ⊕(b...))
end

alldiags=(⊕(noscalelessdiags...))

open("2lGRclass.dot";create=true,write=true) do io
pprint( io,to_graphviz(alldiags,graph_attrs=Dict("layout"=>"neato")))
end

```

```{dot}
//| fig-width: 8
//| label: fig-2lGRclassical
//| fig-cap: "All scaleful diagrams, in the classical limit at 2 loops in GR"
//| file: 2lGRclass.dot
//| cap-location: margin
```


[^measurech]: We changed the integration variable from $r_i$ to $w_i=r_i-\emom[i]$ thus the measure changes:$$\ddP[2+\abs{X}]{r_1,r_2,X}=\ddP[\abs {X}]{r_X}\prod\limits_{i=1,2}\dn[4]{w_i}\ndeltafn{2\emom[i] \cdot w_i+w_i^2}\thetafn{\emom[i]^0+w_i^0}$$ where we used the same reasoning as for the $q_i$ variable change.
    
[^expand]: Here the expansion is in powers of the coupling constant, so even though we want $\hbar$s to cancel, the loop order will still affect the order of the contribution through the coupling constant  $\coupling$  and the (?:lo) corresponds to $\coupling$
[^comp]: Compare to $$\begin{aligned}\dPsb{\tw}&=\dn[4]{\tw} \ndeltafn{2\emom[1]\cdot\tw+\hbar\tw^2}\thetafn{\ct[0]{\emom[1]}+\tm^0}\\& \ndeltafn{2\emom[1]\cdot \tw +\hbar\tw^2}\thetafn{\ct[0]{\emom[2]}+\tm^0}\end{aligned}$$ The theta functions cancel as $\tm^0\to0$ and $\emom[i]$ becomes classical. 




[^shift]: $f(x)=\int \ddP{\emom} \shellft{f}({\emom})\exp{-\frac{\im}{\hbar} \emom^\mu x_\mu}$. Then a shifted, i.e. translated version of $f(x)$ can be written:$$\begin{aligned}f(x-x_0)&=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{-\frac{\im}{\hbar} p_\mu (x^\mu-x_0^\mu)}\\&=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{\frac{\im}{\hbar}p_\mu x^\mu_0}\,\exp{-\frac{\im}{\hbar} p_\mu x^\mu}\end{aligned}$$ Thus the associated, translated state is:$$\ket{f}=\int \ddP{\emom} \shellft{f}({\emom})\,\exp{\frac{\im}{\hbar}p_\mu x^\mu_0}\,\ket{\emom }$$

[^complete]: $1=\sum\limits_X \int \ddP[2+\abs{X}]{r_1,r_2,X}\dyad{r_1 r_2 X}$ Where we could consider the states ${r_1,r_2,X}$ to be the final states after the scattering. Note that we always impose having two (?s:bh), at all times, as we have no pair annihilation, which is why the sum always has a two particle dyad. The additional states encoded in $X$ are all possible additional messenger states (we also have no (?:bh) pair production).

[^measureshift]: Introducing the momentum shifts modifies the measure in the following way:
    $$\begin{aligned}\ddP{\emom[i]'}&=\ddP{\emom[i]+q_i}\\=&\dn[4]{q_i}\,\ndeltafn{{(\emom[i]+q_i)^2-m_i^2}} \thetafn{{\emom[i]^0+q_i^0}}\end{aligned}$$
            Now since we also have the on-shell enforcing delta function from $\ddP{\emom[i]}$ we can rewrite the delta functions:     $$\begin{aligned}\ddP{\emom[i]}&\,\ndeltafn{(\emom[i]+q_i)^2-m_i^2}\\&=\ddP{\emom[i]}\ndeltafn{\underbracket{(\emom[i]^2-m_i^2)}_{\text{redundant}}+2 \emom[i] \cdot q_i+q_i^2}\\&=\ddP{\emom[i]}\ndeltafn{2 \emom[i] \cdot q_i+q_i^2}\end{aligned}$$
            Finally we integrate $q_2$ by solving  $\ndeltafn[(4)]{\emom[1]+\emom[2]-\emom[1]'-\emom[2]'}=\ndeltafn[(4)]{q_1+q_2}$ and thus we just set $q_2=-q_1$

[^constA]: $A$ absorbs the various constants, with $A=\sqrt{2}m\frac{\comptlen}{\wfwidth}$ and $\tv[0]{x}$ 

<!-- [^5]: Here $\tw=\frac{\tm}{\hbar}$ is the wavenumber -->
[^7]: t     $[\frac{1}{\sqrt{-\tw^2}}]=[T]=[L]=[\scatlen]$
